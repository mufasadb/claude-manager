<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Manager Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e5e7eb;
            line-height: 1.6;
        }

        .header {
            background: #111827;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }


        .header-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .header-toggle .toggle-switch {
            width: 50px;
            height: 28px;
        }

        .header-toggle .toggle-slider:before {
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
        }

        .header-toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .settings-cog {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.125rem;
            transition: all 0.2s ease;
        }

        .settings-cog:hover {
            background: #4b5563;
            transform: rotate(90deg);
        }

        /* Target Selection Styles */
        .target-selector {
            margin-bottom: 1rem;
        }

        .target-tabs {
            display: flex;
            border: 1px solid #374151;
            border-radius: 6px;
            overflow: hidden;
            background: #1f2937;
        }

        .target-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: #1f2937;
            color: #9ca3af;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .target-tab:hover {
            background: #374151;
            color: #e5e7eb;
        }

        .target-tab.active {
            background: #3b82f6;
            color: white;
        }

        .target-tab:first-child {
            border-right: 1px solid #374151;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #1f2937;
            border-left: 1px solid #374151;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            background: #111827;
            padding: 1rem;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .settings-content {
            padding: 1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: #374151;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid #4b5563;
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #f9fafb;
        }

        .config-section {
            margin-bottom: 1rem;
        }

        .config-section h3 {
            font-size: 1rem;
            color: #d1d5db;
            margin-bottom: 0.5rem;
        }

        .config-file {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
            position: relative;
        }

        .config-content.collapsible {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .config-content.expanded {
            max-height: none;
        }

        .config-container {
            position: relative;
        }

        .collapse-toggle {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            z-index: 10;
        }

        .collapse-toggle:hover {
            background: #2563eb;
        }

        .edit-toggle {
            position: absolute;
            top: 0.5rem;
            right: 4rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            z-index: 10;
        }

        .edit-toggle:hover {
            background: #059669;
        }

        .json-editor, .markdown-editor {
            width: 100%;
            min-height: 200px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
            padding: 0.75rem;
            border: 1px solid #4b5563;
            border-radius: 4px;
            background: #1f2937;
            color: #e5e7eb;
            resize: vertical;
        }

        .editor-controls {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .btn-small:hover {
            background: #2563eb;
        }

        .btn-small.secondary {
            background: #6b7280;
        }

        .btn-small.secondary:hover {
            background: #4b5563;
        }

        /* Command-specific styles */
        .command-item {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .command-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .command-name {
            font-weight: 600;
            color: #60a5fa;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .command-preview {
            color: #d1d5db;
            font-size: 0.75rem;
            line-height: 1.4;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .command-edit-btn, .command-delete-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.25rem;
            margin-left: 0.25rem;
            border-radius: 3px;
        }

        .command-edit-btn:hover {
            background: #4b5563;
        }

        .command-delete-btn:hover {
            background: #ef4444;
        }

        .command-item.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .command-display {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: 0.75rem;
            margin: 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #e5e7eb;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .command-actions {
            display: flex;
            gap: 0.25rem;
        }

        .command-description {
            color: #d1d5db;
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .command-tools {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .command-body {
            color: #e5e7eb;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .scope-selector {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #374151;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scope-selector label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #d1d5db;
        }

        .scope-selector select {
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: #f9fafb;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .markdown-preview {
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            color: #e5e7eb;
        }

        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .markdown-preview h1 { font-size: 1.5rem; }
        .markdown-preview h2 { font-size: 1.25rem; }
        .markdown-preview h3 { font-size: 1.125rem; }

        .markdown-preview code {
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
        }

        .markdown-preview pre {
            background: #111827;
            padding: 0.75rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .markdown-preview pre code {
            background: none;
            padding: 0;
        }

        .json-syntax {
            white-space: pre-wrap;
        }

        .json-key { color: #059669; font-weight: 600; }
        .json-string { color: #dc2626; }
        .json-number { color: #2563eb; }
        .json-boolean { color: #7c3aed; }
        .json-null { color: #6b7280; }

        .config-file.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .add-form {
            background: #1f2937;
            border: 2px dashed #4b5563;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: end;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #d1d5db;
            margin-bottom: 0.25rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            border-radius: 4px;
            font-size: 0.875rem;
            background: #374151;
            color: #e5e7eb;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .btn:hover {
            background: #2563eb;
        }

        .env-suggestions {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .suggestion-btn {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .suggestion-btn:hover {
            background: #4b5563;
            color: #f3f4f6;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .scope-section {
            margin-bottom: 2rem;
            border: 1px solid #4b5563;
            border-radius: 8px;
            overflow: hidden;
        }

        .scope-header {
            background: #2d3748;
            padding: 1rem;
            border-bottom: 1px solid #4b5563;
            font-weight: 600;
            color: #f9fafb;
            font-size: 1.125rem;
        }

        .scope-content {
            padding: 1.5rem;
            background: #374151;
        }

        .mcp-server {
            padding: 0.75rem;
            background: #1f2937;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .mcp-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #f9fafb;
        }

        .mcp-details {
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .refresh-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .refresh-button:hover {
            background: #2563eb;
        }

        .last-update {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 1rem;
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 2rem;
        }


        /* Environment Variables Styles */
        .env-var {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #1f2937;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            border: 1px solid #374151;
            min-height: 2.5rem;
        }

        .env-var-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .env-var-name {
            font-weight: 600;
            color: #f9fafb;
            min-width: 150px;
        }

        .env-var-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .env-var-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small-env {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .btn-small-env:hover {
            background: #4b5563;
        }

        /* Managed MCP Server Styles */
        .managed-mcp-server {
            padding: 1rem;
            background: #1f2937;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid #374151;
            transition: all 0.2s ease;
        }

        .managed-mcp-server.enabled {
            border-color: #10b981;
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.1);
        }

        .managed-mcp-server.disabled {
            border-color: #6b7280;
            opacity: 0.8;
        }

        .managed-mcp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .managed-mcp-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .managed-mcp-name {
            font-weight: 600;
            font-size: 1rem;
            color: #f9fafb;
        }

        .managed-mcp-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .managed-mcp-status.enabled {
            background: #065f46;
            color: #10b981;
        }

        .managed-mcp-status.disabled {
            background: #374151;
            color: #9ca3af;
        }

        .managed-mcp-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .managed-mcp-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .managed-mcp-detail {
            font-size: 0.875rem;
        }

        .managed-mcp-detail-label {
            color: #9ca3af;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .managed-mcp-detail-value {
            color: #e5e7eb;
            font-family: 'SF Mono', Monaco, monospace;
            word-break: break-all;
        }

        .managed-mcp-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #10b981;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .logs-icon {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .logs-icon:hover {
            background: #4b5563;
            color: #e5e7eb;
            transform: scale(1.05);
        }

        .managed-mcp-template {
            color: #60a5fa;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .managed-mcp-scope {
            color: #f59e0b;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        .btn-small-env.danger {
            background: #ef4444;
        }

        .btn-small-env.danger:hover {
            background: #dc2626;
        }

        .btn-small-env.success {
            background: #10b981;
        }

        .btn-small-env.success:hover {
            background: #059669;
        }

        .btn-small-env.info {
            background: #3b82f6;
        }

        .btn-small-env.info:hover {
            background: #2563eb;
        }

        .project-env-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #111827;
            border-radius: 4px;
            border: 1px solid #374151;
        }

        .project-env-header {
            font-weight: 600;
            color: #f9fafb;
            margin-bottom: 0.5rem;
        }

        .env-var.project-only {
            background: #1e3a8a;
            border-color: #3b82f6;
        }

        /* Alternating project colors */
        .scope-section:nth-child(odd) .scope-content {
            background: #374151;
        }

        .scope-section:nth-child(even) .scope-content {
            background: #4b5563;
        }


        /* Modern Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #10b981;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-weight: 500;
            color: #f9fafb;
        }

        /* Modern Button Styling */
        .btn-modern {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .btn-modern:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        /* Slide-over Panel Styling */
        .slide-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #1f2937;
            border-left: 1px solid #374151;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
        }

        .slide-panel.open {
            right: 0;
        }

        .slide-panel-header {
            background: #111827;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .slide-panel-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .slide-panel-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .slide-panel-close:hover {
            color: white;
        }

        .slide-panel-content {
            padding: 1.5rem;
        }

        .session-info-section {
            background: #111827;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .session-info-section h3 {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .session-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #374151;
        }

        .session-stat:last-child {
            border-bottom: none;
        }

        .session-stat-label {
            color: #e5e7eb;
            font-size: 0.875rem;
        }

        .session-stat-value {
            color: #10b981;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .billing-date-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .billing-date-picker select {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }


        /* Overlay for panel */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .panel-overlay.show {
            display: block;
            opacity: 1;
        }

        /* MCP Variable Modal */
        .mcp-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mcp-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .mcp-modal-content {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .mcp-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .mcp-modal-header h3 {
            color: #f9fafb;
            font-size: 1.25rem;
            margin: 0;
        }

        .mcp-modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mcp-modal-close:hover {
            color: #f9fafb;
        }

        .mcp-modal-body {
            margin-bottom: 2rem;
        }

        .mcp-modal-field {
            margin-bottom: 1rem;
        }

        .mcp-modal-field label {
            display: block;
            color: #d1d5db;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .mcp-modal-field .field-description {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .mcp-modal-field input {
            width: 100%;
            padding: 0.5rem;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: #f9fafb;
            font-size: 0.875rem;
            box-sizing: border-box;
        }

        .env-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .env-input-container input {
            padding-right: 2.5rem;
        }

        .env-var-selector {
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s;
        }

        .env-var-selector:hover {
            color: #3b82f6;
        }

        .env-var-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .env-var-dropdown.show {
            display: block;
        }

        .env-var-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            transition: background-color 0.2s;
        }

        .env-var-item:hover {
            background: #374151;
        }

        .env-var-item:last-child {
            border-bottom: none;
        }

        .env-var-key {
            color: #f9fafb;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .env-var-value {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.125rem;
        }

        .btn-copy {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 1rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
        }

        .btn-copy:hover {
            background: #374151;
            color: #3b82f6;
            transform: scale(1.1);
        }

        .btn-copy:active {
            transform: scale(0.95);
        }

        .mcp-modal-field input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .mcp-modal-field.required label::after {
            content: ' *';
            color: #ef4444;
        }

        .mcp-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .mcp-modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .mcp-modal-btn.cancel {
            background: #374151;
            color: #d1d5db;
        }

        .mcp-modal-btn.cancel:hover {
            background: #4b5563;
        }

        .mcp-modal-btn.confirm {
            background: #3b82f6;
            color: white;
        }

        .mcp-modal-btn.confirm:hover {
            background: #2563eb;
        }

        .mcp-modal-btn.confirm:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- MCP Variable Configuration Modal -->
    <div id="mcpVariableModal" class="mcp-modal">
        <div class="mcp-modal-content">
            <div class="mcp-modal-header">
                <h3 id="mcpModalTitle">Configure MCP Server</h3>
                <button class="mcp-modal-close" onclick="closeMcpModal()">&times;</button>
            </div>
            <div class="mcp-modal-body">
                <div id="mcpModalDescription" class="field-description" style="margin-bottom: 1.5rem;"></div>
                <div id="mcpModalFields"></div>
            </div>
            <div class="mcp-modal-actions">
                <button class="mcp-modal-btn cancel" onclick="closeMcpModal()">Cancel</button>
                <button class="mcp-modal-btn confirm" onclick="confirmMcpVariables()" id="mcpModalConfirm">Add Server</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 32 32" style="margin-right: 0.5rem; vertical-align: middle;">
                <defs>
                    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="16" cy="16" r="15" fill="url(#headerGrad)" stroke="#2563eb" stroke-width="1"/>
                <rect x="6" y="6" width="7" height="7" rx="1" fill="white" opacity="0.9"/>
                <rect x="19" y="6" width="7" height="4" rx="1" fill="white" opacity="0.7"/>
                <rect x="6" y="19" width="7" height="7" rx="1" fill="white" opacity="0.7"/>
                <rect x="19" y="16" width="7" height="10" rx="1" fill="white" opacity="0.9"/>
                <circle cx="9" cy="9" r="1" fill="#3b82f6"/>
                <circle cx="22" cy="8" r="0.8" fill="#10b981"/>
                <circle cx="22" cy="19" r="1" fill="#f59e0b"/>
            </svg>
            <span class="status-indicator status-online" id="headerConnectionStatus"></span>
            Claude Manager Dashboard
        </h1>
        <div class="header-controls">
            <div class="scope-selector">
                <label style="color: #d1d5db; font-size: 0.875rem; margin-right: 0.5rem;">Scope:</label>
                <select id="scopeSelect" onchange="handleScopeChange()" style="background: #374151; color: white; border: 1px solid #4b5563; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; min-width: 150px;">
                    <option value="user">User</option>
                </select>
            </div>
            <div id="sessionTrackingContainer" style="display: flex; align-items: center; gap: 1.5rem;">
                <div id="sessionCountdown" style="display: none; font-size: 0.875rem; color: #10b981;">
                    <span style="font-weight: 600;">Session Active:</span>
                    <span id="countdownTimer" style="font-family: 'SF Mono', Monaco, monospace;">00:00:00</span>
                </div>
                <div class="header-toggle">
                    <span>Session Tracking</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sessionTrackingToggle" onchange="toggleSessionTracking(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                    <button onclick="toggleSessionDetailsPanel()" style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 0.25rem;" title="Session Details">
                        ℹ️
                    </button>
                </div>
            </div>
            <button class="settings-cog" onclick="toggleSettingsPanel()" title="Settings">
                ⚙️
            </button>
        </div>
    </div>


    <div class="container">
        <button class="refresh-button" onclick="refreshData()">🔄 Refresh All Data</button>

        <!-- User Scope Content -->
        <div id="userScopeContent" class="sections">
            <!-- Project Registration Instructions -->
            <div class="scope-section">
                <div class="scope-header">📋 Register New Projects</div>
                <div class="scope-content">
                    <div class="config-section">
                        <h3>How to Register a Project</h3>
                        <div class="config-file">
                            <div style="padding: 1rem; background: #111827; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace;">
                                <div style="color: #10b981; margin-bottom: 0.5rem;">Navigate to any project directory and run:</div>
                                <div style="color: #e5e7eb; margin-bottom: 1rem;">
                                    <span style="color: #6b7280;">$</span> <span style="color: #3b82f6;">cd</span> /path/to/your/project<br>
                                    <span style="color: #6b7280;">$</span> <span style="color: #f59e0b;">cm-reg</span>                      <span style="color: #6b7280;"># Register with directory name</span><br>
                                    <span style="color: #6b7280;">$</span> <span style="color: #f59e0b;">cm-reg</span> my-custom-name       <span style="color: #6b7280;"># Register with custom name</span>
                                </div>
                                <div style="color: #10b981; margin-bottom: 0.5rem;">Setup (one-time installation):</div>
                                <div style="color: #e5e7eb;">
                                    <span style="color: #6b7280;">$</span> <span style="color: #3b82f6;">cd</span> ~/Code/claude-manager<br>
                                    <span style="color: #6b7280;">$</span> <span style="color: #f59e0b;">./install.sh</span>                <span style="color: #6b7280;"># Installs cm-reg command globally</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Level Configuration -->
            <div class="scope-section">
                <div class="scope-header">⚙️ User Configuration (~/.claude/)</div>
                <div class="scope-content">
                    <div class="config-section">
                        <h3>Settings (settings.json)</h3>
                        <div id="userSettings" class="config-file">Loading...</div>
                    </div>
                    <div class="config-section">
                        <h3>Memory (CLAUDE.md)</h3>
                        <div id="userMemory" class="config-file">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Hooks Configuration -->
            <div class="scope-section">
                <div class="scope-header">🪝 Hooks & Automation</div>
                <div class="scope-content">
                    <div class="config-section">
                        <h3>Current Hooks</h3>
                        <div id="userHooks" class="config-file">Loading...</div>
                    </div>
                    <div class="config-section">
                        <h3>Add New Hook</h3>
                        <div class="add-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Event</label>
                                    <select id="hookEvent" onchange="onHookEventChange()">
                                        <option value="PreToolUse">PreToolUse</option>
                                        <option value="PostToolUse">PostToolUse</option>
                                        <option value="Notification">Notification</option>
                                        <option value="Stop">Stop</option>
                                        <option value="SubagentStop">SubagentStop</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Preset (or Custom)</label>
                                    <select id="hookPreset" onchange="onHookPresetChange()">
                                        <option value="">Custom Hook</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tool Pattern</label>
                                    <input type="text" id="hookPattern" placeholder="*" />
                                </div>
                                <div class="form-group">
                                    <label>Command</label>
                                    <textarea id="hookCommand" placeholder="echo 'Hook triggered'" rows="3" style="width: 100%; font-family: monospace; font-size: 0.875rem; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
                                </div>
                                <button class="btn" onclick="addHook()">Add Hook</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Commands Configuration -->
            <div class="scope-section">
                <div class="scope-header">⚡ Commands</div>
                <div class="scope-content">
                    <div id="userScopeCommands" style="display: flex;">
                        <div class="config-section">
                            <h3>User Commands</h3>
                            <div id="userCommands" class="config-file">Loading...</div>
                        </div>
                    </div>
                    <div id="projectScopeCommands" style="display: none;">
                        <div class="config-section">
                            <h3 id="projectCommandsTitle">Project Commands</h3>
                            <div id="projectCommands" class="config-file">Loading...</div>
                        </div>
                    </div>
                    <div class="scope-selector">
                        <label>Scope:</label>
                        <select id="commandsScopeSelect" onchange="handleCommandsScopeChange()">
                            <option value="user">User</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Environment Variables -->
            <div class="scope-section">
                <div class="scope-header">🔐 Environment Variables</div>
                <div class="scope-content">
                    <div class="config-section">
                        <h3>User Level Environment Variables</h3>
                        <div class="add-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Variable Name</label>
                                    <input type="text" id="envKey" placeholder="API_KEY" oninput="updateEnvInputType()" />
                                </div>
                                <div class="form-group">
                                    <label>Value</label>
                                    <input type="text" id="envValue" placeholder="your-secret-value" />
                                </div>
                                <button class="btn" onclick="addUserEnvVar()">Add Variable</button>
                            </div>
                        </div>
                        <div id="userEnvVars">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- MCP Servers -->
            <div class="scope-section">
                <div class="scope-header">🔌 MCP Servers</div>
                <div class="scope-content">
                    <!-- Target Selection -->
                    <div class="target-selector">
                        <div class="target-tabs">
                            <button class="target-tab active" onclick="switchMcpTarget('claude-code')" id="claudeCodeTab">
                                📟 Claude Code CLI
                            </button>
                            <button class="target-tab" onclick="switchMcpTarget('claude-desktop')" id="claudeDesktopTab">
                                🖥️ Claude Desktop
                            </button>
                        </div>
                    </div>

                    <!-- Add MCP Server Form -->
                    <div class="add-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Template</label>
                                <select id="mcpTemplate" onchange="onTemplateChange()">
                                    <option value="">Custom</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Server Name</label>
                                <div class="env-input-container">
                                    <input type="text" id="mcpName" placeholder="my-server" />
                                    <button type="button" class="env-var-selector" onclick="toggleEnvVarDropdown('mcpName')">
                                        📎
                                    </button>
                                    <div class="env-var-dropdown" id="dropdown_mcpName"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Command</label>
                                <div class="env-input-container">
                                    <input type="text" id="mcpCommand" placeholder="node server.js" />
                                    <button type="button" class="env-var-selector" onclick="toggleEnvVarDropdown('mcpCommand')">
                                        📎
                                    </button>
                                    <div class="env-var-dropdown" id="dropdown_mcpCommand"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row" id="claudeCodeScopeRow">
                            <div class="form-group">
                                <label>Scope</label>
                                <select id="mcpScope">
                                    <option value="local">Local (default - project-specific, private)</option>
                                    <option value="user">User (personal utilities, cross-project)</option>
                                    <option value="project">Project (team-shared, version controlled)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Project (for project scope)</label>
                                <select id="mcpProject">
                                    <option value="">Select project...</option>
                                </select>
                            </div>
                            <button class="btn" onclick="addMcpServer()">Add MCP Server</button>
                        </div>
                        <div class="form-row" id="claudeDesktopRow" style="display: none;">
                            <button class="btn" onclick="addMcpServer()">Add to Claude Desktop</button>
                        </div>
                    </div>

                    <!-- MCP Servers Display -->
                    <div id="mcpServersContainer">
                        <div id="mcpServers">Loading...</div>
                        <div id="claudeDesktopMcpServers" style="display: none;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Managed MCP Servers -->
            <div class="scope-section">
                <div class="scope-header">⚙️ Managed MCP Servers</div>
                <div class="scope-content">
                    <p style="color: #9ca3af; margin-bottom: 1rem; font-size: 0.875rem;">
                        Manage MCP servers with isolated configurations. Enable/disable without losing settings.
                    </p>
                    
                    <!-- Migration Button -->
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #374151; border-radius: 6px; border: 1px solid #4b5563;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 600; color: #f9fafb; margin-bottom: 0.25rem;">Import Existing MCP Servers</div>
                                <div style="font-size: 0.875rem; color: #9ca3af;">Migrate your currently active MCP servers to managed mode</div>
                            </div>
                            <button onclick="migrateExistingMcpServers()" class="btn" style="background: #f59e0b; margin-left: 1rem;">
                                Import Servers
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add Managed MCP Server Form -->
                    <div class="add-form">
                        <h3>Add New Managed MCP Server</h3>
                        <div class="form-group">
                            <label for="managedMcpName">Server Name:</label>
                            <input type="text" id="managedMcpName" placeholder="my-server" />
                        </div>
                        <div class="form-group">
                            <label for="managedMcpTemplate">Template:</label>
                            <select id="managedMcpTemplate" onchange="onManagedTemplateChange()">
                                <option value="">Select a template...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="managedMcpScope">Scope:</label>
                            <select id="managedMcpScope" onchange="onManagedMcpScopeChange()">
                                <option value="user">User (Global)</option>
                                <option value="project">Project</option>
                            </select>
                        </div>
                        <div class="form-group" id="managedMcpProjectRow" style="display: none;">
                            <label for="managedMcpProject">Project:</label>
                            <select id="managedMcpProject">
                                <option value="">Select project...</option>
                            </select>
                        </div>
                        <button onclick="addManagedMcpServer()" class="btn">Add Managed Server</button>
                    </div>

                    <!-- Managed MCP Servers List -->
                    <div id="managedMcpServers">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Project Scope Content -->
        <div id="projectScopeContent" class="sections" style="display: none;">
            <div id="selectedProjectContent"></div>
        </div>

        <div class="last-update">
            Last updated: <span id="lastUpdate">-</span>
        </div>
    </div>

    <script>
        let ws;
        let data = {};
        let mcpTemplates = {};
        let currentMcpTarget = 'claude-code'; // 'claude-code' or 'claude-desktop'
        let currentScope = 'user'; // 'user' or project name

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = function() {
                updateConnectionStatus(true);
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (message.type === 'init') {
                    data = message.data;
                    updateUI();
                } else if (message.type === 'fileChange') {
                    refreshData();
                } else if (message.type === 'sessionTracking' || message.type === 'sessionCountdown') {
                    updateSessionCountdown(message.data);
                }
            };

            ws.onclose = function() {
                updateConnectionStatus(false);
                setTimeout(connect, 3000);
            };

            ws.onerror = function() {
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const headerIndicator = document.getElementById('headerConnectionStatus');
            
            if (connected) {
                headerIndicator.className = 'status-indicator status-online';
            } else {
                headerIndicator.className = 'status-indicator status-offline';
            }
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/status');
                data = await response.json();
                // Store data globally for env var functions
                window.currentState = data;
                updateUI();
            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }

        function updateUI() {
            updateScopeDropdown();
            updateUserConfig();
            updateUserHooks();
            updateUserEnvVars();
            updateMcpServers();
            updateProjectsList();
            updateLastUpdate();
            updateScopeContent();
            updateCommandsScopeDropdown();
            updateUserCommands();
        }

        // Scope Management Functions
        function updateScopeDropdown() {
            const scopeSelect = document.getElementById('scopeSelect');
            
            // Clear existing options except User
            scopeSelect.innerHTML = '<option value="user">User</option>';
            
            // Add project options
            if (data.projects) {
                Object.entries(data.projects).forEach(([name, project]) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${project.path})`;
                    scopeSelect.appendChild(option);
                });
            }
            
            // Set current scope
            scopeSelect.value = currentScope;
        }

        function handleScopeChange() {
            const scopeSelect = document.getElementById('scopeSelect');
            currentScope = scopeSelect.value;
            updateScopeContent();
        }

        function updateScopeContent() {
            const userContent = document.getElementById('userScopeContent');
            const projectContent = document.getElementById('projectScopeContent');
            const selectedProjectContent = document.getElementById('selectedProjectContent');
            
            if (currentScope === 'user') {
                // Show user content
                userContent.style.display = 'flex';
                projectContent.style.display = 'none';
            } else {
                // Show project content
                userContent.style.display = 'none';
                projectContent.style.display = 'flex';
                
                // Populate project-specific content
                updateSelectedProjectContent(currentScope);
            }
            
            // Update MCP form defaults based on current scope
            updateMcpFormDefaults();
        }

        function updateMcpFormDefaults() {
            const mcpScopeSelect = document.getElementById('mcpScope');
            const mcpProjectSelect = document.getElementById('mcpProject');
            
            if (currentScope === 'user') {
                // Set default to user scope
                mcpScopeSelect.value = 'user';
                mcpProjectSelect.value = '';
            } else {
                // Set default to project scope and pre-select the current project
                mcpScopeSelect.value = 'project';
                if (data.projects[currentScope]) {
                    mcpProjectSelect.value = data.projects[currentScope].path;
                }
            }
        }

        function updateSelectedProjectContent(projectName) {
            const container = document.getElementById('selectedProjectContent');
            const project = data.projects?.[projectName];
            
            if (!project) {
                container.innerHTML = '<div class="empty-state">Project not found</div>';
                return;
            }

            let configSections = '';
            
            // Build configuration sections
            if (project.config) {
                configSections = Object.entries(project.config).map(([type, content]) => {
                    let displayContent;
                    let className = 'config-file';
                    let fileType = 'text';
                    let filePath = '';

                    // Determine file type and path
                    if (type === 'memory') {
                        fileType = 'markdown';
                        filePath = `${project.path}/CLAUDE.md`;
                    } else if (type === 'settings' || type === 'settingsLocal') {
                        fileType = 'json';
                        filePath = type === 'settings' ? 
                            `${project.path}/.claude/settings.json` : 
                            `${project.path}/.claude/settings.local.json`;
                    } else if (type === 'commands') {
                        fileType = 'commands';
                        filePath = `${project.path}/.claude/commands/`;
                    }

                    if (content?.error) {
                        className += ' error';
                        displayContent = `Error: ${content.error}`;
                    } else if (type === 'commands') {
                        className += ' collapsible';
                        displayContent = createCommandsDisplay(content, projectName);
                    } else if (typeof content === 'string') {
                        className += ' collapsible';
                        displayContent = createConfigDisplay(content, fileType, filePath);
                    } else {
                        className += ' collapsible';
                        const prettyJson = JSON.stringify(content, null, 2);
                        displayContent = createConfigDisplay(prettyJson, fileType, filePath);
                    }

                    return `
                        <div class="config-section">
                            <h3>${type}</h3>
                            <div class="${className}">${displayContent}</div>
                        </div>
                    `;
                }).join('');
            }

            // Add environment variables section
            const projectEnvVars = data.projectEnvVars?.[projectName] || {};
            const userEnvVars = data.userEnvVars || {};
            
            let envSection = '';
            if (Object.keys(projectEnvVars).length > 0 || Object.keys(userEnvVars).length > 0) {
                const envHtml = Object.entries(projectEnvVars).map(([key, value]) => {
                    const isUserLevel = key in userEnvVars;
                    const className = isUserLevel ? 'env-var' : 'env-var project-only';
                    const label = isUserLevel ? '(User + Project)' : '(Project Only)';
                    const displayValue = displayEnvValue(value);
                    
                    return `
                        <div class="${className}">
                            <div class="env-var-info">
                                <div class="env-var-name">${escapeHtml(key)} ${label}</div>
                                <div class="env-var-value">${displayValue}</div>
                            </div>
                            <div class="env-var-actions">
                                <button class="btn-copy" onclick="copyToClipboard(\`${value.replace(/`/g, '\\`')}\`, '${escapeHtml(key)}')" title="Copy value to clipboard">
                                    📋
                                </button>
                                <button class="btn-small-env info" onclick="copyEnvToUser('${escapeHtml(projectName)}', '${escapeHtml(key)}')">Copy to User</button>
                                <button class="btn-small-env danger" onclick="deleteEnvFromProject('${escapeHtml(projectName)}', '${escapeHtml(key)}')">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                envSection = `
                    <div class="config-section">
                        <h3>Environment Variables</h3>
                        <div class="project-env-section">
                            ${envHtml || '<div class="empty-state">No environment variables in this project</div>'}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="scope-section">
                    <div class="scope-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>📁 Project: ${projectName} (${project.path})</span>
                        <button class="btn-small-env danger" onclick="unregisterProject('${escapeHtml(projectName)}')" title="Unregister this project">
                            🗑️ Unregister
                        </button>
                    </div>
                    <div class="scope-content">
                        ${configSections}
                        ${envSection}
                    </div>
                </div>
            `;
        }

        function updateUserConfig() {
            const userSettings = document.getElementById('userSettings');
            const userMemory = document.getElementById('userMemory');

            if (data.userConfig?.settings) {
                if (data.userConfig.settings.error) {
                    userSettings.className = 'config-file error';
                    userSettings.innerHTML = `Error: ${data.userConfig.settings.error}`;
                } else {
                    userSettings.className = 'config-file collapsible';
                    userSettings.innerHTML = createConfigDisplay(
                        JSON.stringify(data.userConfig.settings, null, 2),
                        'json',
                        '~/.claude/settings.json'
                    );
                }
            } else {
                userSettings.className = 'config-file';
                userSettings.innerHTML = createConfigDisplay(
                    'No settings file found',
                    'json',
                    '~/.claude/settings.json',
                    true
                );
            }

            if (data.userConfig?.memory) {
                if (data.userConfig.memory.error) {
                    userMemory.className = 'config-file error';
                    userMemory.innerHTML = `Error: ${data.userConfig.memory.error}`;
                } else {
                    userMemory.className = 'config-file collapsible';
                    userMemory.innerHTML = createConfigDisplay(
                        data.userConfig.memory,
                        'markdown',
                        '~/.claude/CLAUDE.md'
                    );
                }
            } else {
                userMemory.className = 'config-file';
                userMemory.innerHTML = createConfigDisplay(
                    'No memory file found',
                    'markdown',
                    '~/.claude/CLAUDE.md',
                    true
                );
            }
        }

        // Commands Management Functions
        function updateUserCommands() {
            const userCommands = document.getElementById('userCommands');
            
            if (data.userConfig?.commands) {
                if (data.userConfig.commands.error) {
                    userCommands.className = 'config-file error';
                    userCommands.innerHTML = `Error: ${data.userConfig.commands.error}`;
                } else {
                    userCommands.className = 'config-file collapsible';
                    userCommands.innerHTML = createCommandsDisplayV2(data.userConfig.commands, 'user');
                }
            } else {
                userCommands.className = 'config-file';
                userCommands.innerHTML = createCommandsDisplayV2({}, 'user', true);
            }
        }

        function updateProjectCommands(projectName) {
            const projectCommands = document.getElementById('projectCommands');
            const projectCommandsTitle = document.getElementById('projectCommandsTitle');
            
            if (!projectName || !data.projects?.[projectName]) {
                projectCommands.innerHTML = '<div class="empty-state">No project selected</div>';
                return;
            }

            const project = data.projects[projectName];
            projectCommandsTitle.textContent = `Commands for ${projectName}`;
            
            if (project.config?.commands) {
                if (project.config.commands.error) {
                    projectCommands.className = 'config-file error';
                    projectCommands.innerHTML = `Error: ${project.config.commands.error}`;
                } else {
                    projectCommands.className = 'config-file collapsible';
                    projectCommands.innerHTML = createCommandsDisplayV2(project.config.commands, projectName);
                }
            } else {
                projectCommands.className = 'config-file';
                projectCommands.innerHTML = createCommandsDisplayV2({}, projectName, true);
            }
        }

        function updateCommandsScopeDropdown() {
            const commandsScopeSelect = document.getElementById('commandsScopeSelect');
            
            // Clear existing options except User
            commandsScopeSelect.innerHTML = '<option value="user">User</option>';
            
            // Add project options
            if (data.projects) {
                Object.entries(data.projects).forEach(([name, project]) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = `${name} (${project.path})`;
                    commandsScopeSelect.appendChild(option);
                });
            }
        }

        function handleCommandsScopeChange() {
            const commandsScopeSelect = document.getElementById('commandsScopeSelect');
            const selectedScope = commandsScopeSelect.value;
            
            const userScopeCommands = document.getElementById('userScopeCommands');
            const projectScopeCommands = document.getElementById('projectScopeCommands');
            
            if (selectedScope === 'user') {
                userScopeCommands.style.display = 'flex';
                projectScopeCommands.style.display = 'none';
                updateUserCommands();
            } else {
                userScopeCommands.style.display = 'none';
                projectScopeCommands.style.display = 'flex';
                updateProjectCommands(selectedScope);
            }
        }

        // MCP Target Management
        function switchMcpTarget(target) {
            currentMcpTarget = target;
            
            // Update tab appearance
            document.getElementById('claudeCodeTab').classList.toggle('active', target === 'claude-code');
            document.getElementById('claudeDesktopTab').classList.toggle('active', target === 'claude-desktop');
            
            // Show/hide appropriate forms and content
            document.getElementById('claudeCodeScopeRow').style.display = target === 'claude-code' ? 'flex' : 'none';
            document.getElementById('claudeDesktopRow').style.display = target === 'claude-desktop' ? 'flex' : 'none';
            
            // Show/hide appropriate server lists
            document.getElementById('mcpServers').style.display = target === 'claude-code' ? 'block' : 'none';
            document.getElementById('claudeDesktopMcpServers').style.display = target === 'claude-desktop' ? 'block' : 'none';
            
            // Load appropriate server list
            if (target === 'claude-desktop') {
                updateClaudeDesktopMcpServers();
            } else {
                updateMcpServers();
            }
        }

        function updateClaudeDesktopMcpServers() {
            fetch('/api/claude-desktop-mcp-servers')
                .then(response => response.json())
                .then(servers => {
                    const container = document.getElementById('claudeDesktopMcpServers');
                    
                    if (servers.error) {
                        container.innerHTML = `<div class="config-file error">Error: ${servers.error}</div>`;
                        return;
                    }

                    if (Object.keys(servers).length === 0) {
                        container.innerHTML = '<div class="empty-state">No Claude Desktop MCP servers configured</div>';
                        return;
                    }

                    const serversList = Object.entries(servers).map(([name, config]) => {
                        const commandDisplay = `${config.command} ${config.args ? config.args.join(' ') : ''}`.trim();
                        
                        return `
                            <div class="config-file">
                                <div class="config-header">
                                    <span class="config-title">${name}</span>
                                    <div class="config-actions">
                                        <button class="btn-small btn-danger" onclick="removeClaudeDesktopMcpServer('${name}')">Remove</button>
                                    </div>
                                </div>
                                <div class="config-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Command:</span>
                                        <span class="detail-value">${commandDisplay}</span>
                                    </div>
                                    ${config.args && config.args.length > 0 ? `
                                        <div class="detail-row">
                                            <span class="detail-label">Arguments:</span>
                                            <span class="detail-value">${config.args.join(', ')}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = serversList;
                })
                .catch(error => {
                    document.getElementById('claudeDesktopMcpServers').innerHTML = 
                        `<div class="config-file error">Failed to load Claude Desktop MCP servers: ${error.message}</div>`;
                });
        }

        async function removeClaudeDesktopMcpServer(name) {
            if (!confirm(`Remove Claude Desktop MCP server "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/remove-claude-desktop-mcp-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'MCP server removed successfully');
                    updateClaudeDesktopMcpServers();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function removeMcpServer(name, scope = 'user') {
            const scopeLabel = scope === 'user' ? 'user-level' : `project ${scope}`;
            if (!confirm(`Remove MCP server "${name}" from ${scopeLabel}?`)) {
                return;
            }

            try {
                // Show loading feedback
                const serverElement = document.querySelector(`button[onclick*="removeMcpServer('${name}'"]`).closest('.config-file');
                if (serverElement) {
                    serverElement.style.opacity = '0.5';
                    serverElement.style.pointerEvents = 'none';
                }

                // Prepare request body with scope information
                const requestBody = { name, scope };
                if (scope !== 'user' && data.projects[scope]) {
                    requestBody.projectPath = data.projects[scope].path;
                }

                const response = await fetch('/api/remove-mcp-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Immediately refresh the MCP servers data
                    await refreshData();
                    
                    // Show success message
                    alert(result.message || 'MCP server removed successfully');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                    
                    // Restore the element if there was an error
                    if (serverElement) {
                        serverElement.style.opacity = '1';
                        serverElement.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
                
                // Restore the element if there was an error
                const serverElement = document.querySelector(`button[onclick="removeMcpServer('${name}')"]`)?.closest('.config-file');
                if (serverElement) {
                    serverElement.style.opacity = '1';
                    serverElement.style.pointerEvents = 'auto';
                }
            }
        }

        function updateMcpServers() {
            const container = document.getElementById('mcpServers');
            
            // Determine which MCP servers to show based on current scope
            let mcpServers;
            let scopeLabel;
            
            if (currentScope === 'user') {
                mcpServers = data.mcpServers;
                scopeLabel = 'User-level MCP Servers';
            } else {
                // Project scope - get servers for this specific project
                mcpServers = data.projectMcpServers?.[currentScope] || {};
                scopeLabel = `MCP Servers for ${currentScope}`;
            }
            
            if (mcpServers?.error) {
                container.innerHTML = `<div class="config-file error">Error: ${mcpServers.error}</div>`;
                return;
            }

            if (!mcpServers || Object.keys(mcpServers).length === 0) {
                const emptyMessage = currentScope === 'user' 
                    ? 'No user-level MCP servers configured'
                    : `No MCP servers configured for ${currentScope}`;
                container.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                return;
            }

            if (mcpServers.info) {
                container.innerHTML = `<div class="config-file">${mcpServers.info}</div>`;
                return;
            }

            const html = Object.entries(mcpServers).map(([name, config]) => {
                const configJson = typeof config === 'string' ? config : JSON.stringify(config, null, 2);
                let commandDisplay = '';
                
                try {
                    if (typeof config === 'object' && config.command) {
                        commandDisplay = config.command;
                        if (config.args && Array.isArray(config.args)) {
                            commandDisplay += ' ' + config.args.join(' ');
                        }
                    } else {
                        commandDisplay = configJson;
                    }
                } catch (e) {
                    commandDisplay = configJson;
                }
                
                return `
                    <div class="config-file">
                        <div class="config-header">
                            <span class="config-title">${name}</span>
                            <div class="config-actions">
                                <button class="btn-small btn-danger" onclick="removeMcpServer('${name}', '${currentScope}')">Remove</button>
                            </div>
                        </div>
                        <div class="config-details">
                            <div class="detail-row">
                                <span class="detail-label">Command:</span>
                                <span class="detail-value">${commandDisplay}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function updateUserHooks() {
            const container = document.getElementById('userHooks');
            
            if (data.userConfig?.settings?.hooks) {
                container.className = 'config-file collapsible';
                const hooksJson = JSON.stringify(data.userConfig.settings.hooks, null, 2);
                container.innerHTML = createConfigDisplay(
                    hooksJson,
                    'json',
                    '~/.claude/settings.json'
                );
            } else {
                container.className = 'config-file';
                container.innerHTML = createConfigDisplay(
                    'No hooks configured',
                    'json',
                    '~/.claude/settings.json',
                    true
                );
            }
        }


        function updateLastUpdate() {
            const element = document.getElementById('lastUpdate');
            if (data.lastUpdate) {
                element.textContent = new Date(data.lastUpdate).toLocaleString();
            }
        }

        // Environment Variables Functions
        function updateUserEnvVars() {
            const container = document.getElementById('userEnvVars');
            
            if (data.userEnvVars?.error) {
                container.innerHTML = `<div class="config-file error">Error: ${data.userEnvVars.error}</div>`;
                return;
            }

            if (!data.userEnvVars || Object.keys(data.userEnvVars).length === 0) {
                container.innerHTML = '<div class="empty-state">No user environment variables configured</div>';
                return;
            }

            const html = Object.entries(data.userEnvVars).map(([key, value]) => {
                const displayValue = displayEnvValue(value);
                return `
                    <div class="env-var">
                        <div class="env-var-info">
                            <div class="env-var-name">${escapeHtml(key)}</div>
                            <div class="env-var-value">${displayValue}</div>
                        </div>
                        <div class="env-var-actions">
                            <button class="btn-copy" onclick="copyToClipboard(\`${value.replace(/`/g, '\\`')}\`, '${escapeHtml(key)}')" title="Copy value to clipboard">
                                📋
                            </button>
                            <button class="btn-small-env success" onclick="addToProject('${escapeHtml(key)}', '${escapeHtml(value)}')">Add to Project</button>
                            <button class="btn-small-env danger" onclick="deleteUserEnvVar('${escapeHtml(key)}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function displayEnvValue(value) {
            if (!value) return '';
            
            // Show actual values, truncate if too long for display
            const maxDisplayLength = 50;
            
            if (value.length <= maxDisplayLength) {
                return escapeHtml(value);
            }
            
            // For very long values, show first part with ellipsis
            return escapeHtml(value.substring(0, maxDisplayLength)) + '...';
        }

        function updateEnvInputType() {
            const keyInput = document.getElementById('envKey');
            const valueInput = document.getElementById('envValue');
            
            if (keyInput && valueInput) {
                // Always use text input type - no more masking
                valueInput.type = 'text';
            }
        }

        function setEnvVar(key, value) {
            document.getElementById('envKey').value = key;
            document.getElementById('envValue').value = value;
            updateEnvInputType(); // Update input type based on key
        }

        async function addUserEnvVar() {
            const key = document.getElementById('envKey').value;
            const value = document.getElementById('envValue').value;
            
            if (!key || !value) {
                alert('Please enter both key and value');
                return;
            }

            try {
                const response = await fetch('/api/add-user-env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value })
                });
                
                if (response.ok) {
                    document.getElementById('envKey').value = '';
                    document.getElementById('envValue').value = '';
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteUserEnvVar(key) {
            if (!confirm(`Delete environment variable "${key}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete-user-env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                
                if (response.ok) {
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function addToProject(key, value) {
            // Show project selection dialog
            if (!data.projects || Object.keys(data.projects).length === 0) {
                alert('No projects available');
                return;
            }

            // Create modal dialog with dropdown
            showProjectSelectionModal(key, value);
        }

        function showProjectSelectionModal(envKey, envValue) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #374151;
                border-radius: 8px;
                padding: 2rem;
                min-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                border: 1px solid #4b5563;
            `;

            // Build project options
            const projectOptions = Object.entries(data.projects).map(([name, project]) => 
                `<option value="${name}">${name} (${project.path})</option>`
            ).join('');

            modalContent.innerHTML = `
                <h3 style="color: #f9fafb; margin-bottom: 1rem; font-size: 1.25rem;">
                    Add "${envKey}" to Project
                </h3>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                        Select Project:
                    </label>
                    <select id="projectSelectModal" style="width: 100%; padding: 0.75rem; border: 1px solid #4b5563; border-radius: 4px; font-size: 0.875rem; background: #1f2937; color: #e5e7eb;">
                        <option value="">Choose a project...</option>
                        ${projectOptions}
                    </select>
                </div>
                <div style="margin-bottom: 1.5rem; padding: 0.75rem; background: #1f2937; border-radius: 4px; border: 1px solid #374151;">
                    <div style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem;">Variable Details:</div>
                    <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 0.875rem;">
                        <div style="color: #10b981;"><strong>Key:</strong> ${escapeHtml(envKey)}</div>
                        <div style="color: #f59e0b;"><strong>Value:</strong> ${displayEnvValue(envValue)}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button id="cancelProjectModal" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                        Cancel
                    </button>
                    <button id="confirmProjectModal" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;" disabled>
                        Add to Project
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Add event listeners
            const projectSelect = document.getElementById('projectSelectModal');
            const confirmBtn = document.getElementById('confirmProjectModal');
            const cancelBtn = document.getElementById('cancelProjectModal');

            projectSelect.addEventListener('change', () => {
                confirmBtn.disabled = !projectSelect.value;
                if (projectSelect.value) {
                    confirmBtn.style.background = '#10b981';
                } else {
                    confirmBtn.style.background = '#6b7280';
                }
            });

            confirmBtn.addEventListener('click', async () => {
                const selectedProject = projectSelect.value;
                if (!selectedProject) return;

                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Adding...';

                try {
                    const response = await fetch('/api/add-env-to-project', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            projectName: selectedProject, 
                            key: envKey, 
                            value: envValue 
                        })
                    });
                    
                    if (response.ok) {
                        alert(`✅ Added "${envKey}" to project "${selectedProject}"`);
                        refreshData();
                        document.body.removeChild(modal);
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`);
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Add to Project';
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Add to Project';
                }
            });

            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            // Close on Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        async function deleteEnvFromProject(projectName, key) {
            if (!confirm(`Remove environment variable "${key}" from project "${projectName}"?`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete-env-from-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, key })
                });
                
                if (response.ok) {
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function copyEnvToUser(projectName, key) {
            try {
                const response = await fetch('/api/copy-env-to-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, key })
                });
                
                if (response.ok) {
                    refreshData();
                    alert(`Environment variable "${key}" copied to user level`);
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Load templates, projects, and hooks
        let templates = {};
        let commonHooks = {};
        
        async function loadTemplates() {
            try {
                const response = await fetch('/api/mcp-templates');
                mcpTemplates = await response.json();
                
                const templateSelect = document.getElementById('mcpTemplate');
                Object.entries(mcpTemplates).forEach(([key, template]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${template.name} - ${template.description}`;
                    templateSelect.appendChild(option);
                });

                // Also populate managed MCP server template
                const managedSelect = document.getElementById('managedMcpTemplate');
                if (managedSelect) {
                    managedSelect.innerHTML = '<option value="">Select a template...</option>';
                    
                    Object.entries(mcpTemplates).forEach(([key, template]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${template.name} - ${template.description}`;
                        managedSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        }

        // Managed MCP Server Functions
        function loadManagedMcpServers() {
            fetch('/api/managed-mcp-servers')
                .then(response => response.json())
                .then(servers => {
                    displayManagedMcpServers(servers);
                })
                .catch(error => {
                    console.error('Error loading managed MCP servers:', error);
                    document.getElementById('managedMcpServers').innerHTML = 
                        '<div class="config-file error">Error loading managed MCP servers</div>';
                });
        }

        function displayManagedMcpServers(servers) {
            const container = document.getElementById('managedMcpServers');
            
            if (!servers || Object.keys(servers).length === 0) {
                container.innerHTML = '<div class="empty-state">No managed MCP servers configured</div>';
                return;
            }

            let html = '';
            Object.entries(servers).forEach(([name, server]) => {
                const statusClass = server.enabled ? 'enabled' : 'disabled';
                const statusText = server.enabled ? 'Enabled' : 'Disabled';
                
                html += `
                    <div class="managed-mcp-server ${statusClass}">
                        <div class="managed-mcp-header">
                            <div class="managed-mcp-title">
                                <div class="managed-mcp-name">${escapeHtml(name)}</div>
                                <div class="managed-mcp-status ${statusClass}">${statusText}</div>
                                <div class="managed-mcp-template">${escapeHtml(server.template)}</div>
                                <div class="managed-mcp-scope">${escapeHtml(server.scope)}</div>
                            </div>
                            <div class="managed-mcp-controls">
                                <label class="toggle-switch" title="Enable/Disable Server">
                                    <input type="checkbox" ${server.enabled ? 'checked' : ''} 
                                           onchange="toggleManagedMcpServer('${escapeHtml(name)}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <a href="#" class="logs-icon" title="View Logs" onclick="viewMcpServerLogs('${escapeHtml(name)}')">
                                    📄
                                </a>
                                <button class="delete-btn" onclick="deleteManagedMcpServer('${escapeHtml(name)}')" title="Delete Server">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        <div class="managed-mcp-details">
                            <div class="managed-mcp-detail">
                                <div class="managed-mcp-detail-label">Command</div>
                                <div class="managed-mcp-detail-value">${escapeHtml(server.command || 'N/A')}</div>
                            </div>
                            <div class="managed-mcp-detail">
                                <div class="managed-mcp-detail-label">Template</div>
                                <div class="managed-mcp-detail-value">${escapeHtml(server.templateConfig?.name || server.template)}</div>
                            </div>
                            <div class="managed-mcp-detail">
                                <div class="managed-mcp-detail-label">Environment Variables</div>
                                <div class="managed-mcp-detail-value">${Object.keys(server.envVars || {}).length} vars</div>
                            </div>
                            <div class="managed-mcp-detail">
                                <div class="managed-mcp-detail-label">Created</div>
                                <div class="managed-mcp-detail-value">${new Date(server.createdAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function addManagedMcpServer() {
            const name = document.getElementById('managedMcpName').value;
            const template = document.getElementById('managedMcpTemplate').value;
            const scope = document.getElementById('managedMcpScope').value;
            const project = document.getElementById('managedMcpProject').value;

            if (!name || !template) {
                alert('Please provide a server name and select a template');
                return;
            }

            try {
                // Get template configuration to check for parameters/env vars
                const templateConfig = mcpTemplates[template];

                // Check if template needs parameters or environment variables
                if ((templateConfig.parameters && templateConfig.parameters.length > 0) || 
                    (templateConfig.envVars && templateConfig.envVars.length > 0)) {
                    // Show modal for configuration
                    showManagedMcpVariableModal(template, templateConfig);
                    return;
                }

                // Add directly if no parameters needed
                await performManagedMcpServerAdd({}, {});
            } catch (error) {
                console.error('Error adding managed MCP server:', error);
                alert('Error adding managed MCP server: ' + error.message);
            }
        }

        function showManagedMcpVariableModal(template, templateConfig) {
            // Reuse the existing modal but for managed servers
            const modal = document.getElementById('mcpVariableModal');
            const title = document.getElementById('mcpModalTitle');
            const container = document.getElementById('mcpModalVariables');

            title.textContent = `Configure ${templateConfig.name}`;
            modal.dataset.template = template;
            modal.dataset.isManaged = 'true'; // Flag to indicate this is for managed servers

            let html = '';

            // Add parameters
            if (templateConfig.parameters) {
                templateConfig.parameters.forEach(param => {
                    html += `
                        <div class="variable-group">
                            <label for="param_${param.name}">${param.label || param.name}:</label>
                            <input type="text" 
                                   id="param_${param.name}" 
                                   placeholder="${param.default || ''}"
                                   title="${param.description || ''}" />
                            ${param.required ? '<span style="color: #ef4444;">*</span>' : ''}
                        </div>
                    `;
                });
            }

            // Add environment variables
            if (templateConfig.envVars) {
                templateConfig.envVars.forEach(envVar => {
                    html += `
                        <div class="variable-group">
                            <label for="env_${envVar.name}">${envVar.label || envVar.name}:</label>
                            <input type="password" 
                                   id="env_${envVar.name}" 
                                   placeholder="Enter ${envVar.name}"
                                   title="${envVar.description || ''}" />
                            ${envVar.required ? '<span style="color: #ef4444;">*</span>' : ''}
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
            modal.classList.add('show');
        }

        async function performManagedMcpServerAdd(parameters = {}, envVars = {}) {
            const name = document.getElementById('managedMcpName').value;
            const template = document.getElementById('managedMcpTemplate').value;
            const scope = document.getElementById('managedMcpScope').value;
            const project = document.getElementById('managedMcpProject').value;

            const projectPath = scope === 'project' && project ? 
                globalState.projects[project]?.path : null;

            try {
                const response = await fetch('/api/add-managed-mcp-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        template,
                        parameters,
                        envVars,
                        scope,
                        projectPath
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Clear form
                    document.getElementById('managedMcpName').value = '';
                    document.getElementById('managedMcpTemplate').value = '';
                    
                    // Reload managed servers
                    loadManagedMcpServers();
                    
                    alert(result.message || 'Managed MCP server added successfully');
                } else {
                    throw new Error(result.error || 'Failed to add managed MCP server');
                }
            } catch (error) {
                console.error('Error adding managed MCP server:', error);
                alert('Error: ' + error.message);
            }
        }

        async function toggleManagedMcpServer(name, enabled) {
            try {
                const action = enabled ? 'enable' : 'disable';
                const response = await fetch(`/api/${action}-managed-mcp-server`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Reload managed servers and regular servers
                    loadManagedMcpServers();
                    refreshData();
                } else {
                    throw new Error(result.error || `Failed to ${action} server`);
                }
            } catch (error) {
                console.error(`Error toggling managed MCP server:`, error);
                alert('Error: ' + error.message);
                // Reload to reset toggle state
                loadManagedMcpServers();
            }
        }

        async function deleteManagedMcpServer(name) {
            if (!confirm(`Delete managed MCP server "${name}"? This will remove the configuration permanently.`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete-managed-mcp-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();
                
                if (result.success) {
                    loadManagedMcpServers();
                    refreshData();
                } else {
                    throw new Error(result.error || 'Failed to delete server');
                }
            } catch (error) {
                console.error('Error deleting managed MCP server:', error);
                alert('Error: ' + error.message);
            }
        }

        async function viewMcpServerLogs(serverName) {
            try {
                const response = await fetch(`/api/mcp-server-logs/${encodeURIComponent(serverName)}`);
                const result = await response.json();
                
                if (result.success) {
                    // Open logs file in default editor/viewer
                    if (result.exists) {
                        // On macOS, use 'open' command to open with default app
                        if (confirm(`Open logs file for ${serverName}?\n\nPath: ${result.logsPath}`)) {
                            window.open(`file://${result.logsPath}`, '_blank');
                        }
                    } else {
                        alert(`Logs file not found for ${serverName}.\n\nExpected path: ${result.logsPath}`);
                    }
                } else {
                    throw new Error(result.error || 'Failed to get logs path');
                }
            } catch (error) {
                console.error('Error viewing MCP server logs:', error);
                alert('Error: ' + error.message);
            }
        }

        function onManagedTemplateChange() {
            const template = document.getElementById('managedMcpTemplate').value;
            // Could add template-specific UI updates here if needed
        }

        function onManagedMcpScopeChange() {
            const scope = document.getElementById('managedMcpScope').value;
            const projectRow = document.getElementById('managedMcpProjectRow');
            
            if (scope === 'project') {
                projectRow.style.display = 'block';
            } else {
                projectRow.style.display = 'none';
            }
        }

        async function migrateExistingMcpServers() {
            if (!confirm('This will import your currently active MCP servers into the managed system. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/migrate-existing-mcp-servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (result.success) {
                    let message = `Migration completed!\n\n`;
                    
                    if (result.migrated.length > 0) {
                        message += `✅ Migrated ${result.migrated.length} servers:\n`;
                        result.migrated.forEach(server => {
                            message += `  • ${server.name} (${server.template})\n`;
                        });
                        message += '\n';
                    }
                    
                    if (result.skipped.length > 0) {
                        message += `⏭️ Skipped ${result.skipped.length} servers:\n`;
                        result.skipped.forEach(server => {
                            message += `  • ${server.name}: ${server.reason}\n`;
                        });
                        message += '\n';
                    }
                    
                    if (result.errors.length > 0) {
                        message += `❌ Errors with ${result.errors.length} servers:\n`;
                        result.errors.forEach(server => {
                            message += `  • ${server.name}: ${server.error}\n`;
                        });
                    }
                    
                    alert(message);
                    
                    // Reload managed servers to show the new imports
                    loadManagedMcpServers();
                } else {
                    throw new Error(result.error || 'Migration failed');
                }
            } catch (error) {
                console.error('Error migrating MCP servers:', error);
                alert('Error migrating MCP servers: ' + error.message);
            }
        }

        async function loadCommonHooks() {
            try {
                const response = await fetch('/api/common-hooks');
                commonHooks = await response.json();
                onHookEventChange(); // Populate initial preset options
            } catch (error) {
                console.error('Failed to load common hooks:', error);
            }
        }

        function onTemplateChange() {
            const templateKey = document.getElementById('mcpTemplate').value;
            const nameInput = document.getElementById('mcpName');
            const commandInput = document.getElementById('mcpCommand');
            
            // Clear existing parameter form
            clearMcpParameterForm();
            
            if (templateKey && mcpTemplates[templateKey]) {
                const template = mcpTemplates[templateKey];
                nameInput.value = templateKey;
                commandInput.value = template.command;
                commandInput.disabled = true;
                
                // Show parameter form if template has parameters or env vars
                if (template.parameters || template.envVars) {
                    showMcpParameterForm(template);
                }
            } else {
                nameInput.value = '';
                commandInput.value = '';
                commandInput.disabled = false;
            }
        }

        function clearMcpParameterForm() {
            const existingForm = document.getElementById('mcpParameterForm');
            if (existingForm) {
                existingForm.remove();
            }
        }

        function showMcpParameterForm(template) {
            const mcpSection = document.querySelector('.scope-section .scope-content .add-form');
            
            const parameterForm = document.createElement('div');
            parameterForm.id = 'mcpParameterForm';
            parameterForm.style.cssText = `
                background: #111827;
                border: 1px solid #374151;
                border-radius: 6px;
                padding: 1rem;
                margin-top: 1rem;
            `;
            
            let formHTML = `
                <h4 style="color: #f9fafb; margin-bottom: 1rem; font-size: 1rem;">
                    Configuration for ${template.name}
                </h4>
            `;
            
            // Add parameter fields
            if (template.parameters) {
                template.parameters.forEach(param => {
                    const suggestions = findEnvSuggestions(param.envHints || [param.name]);
                    formHTML += createParameterField(param, suggestions, 'parameter');
                });
            }
            
            // Add environment variable fields
            if (template.envVars) {
                template.envVars.forEach(envVar => {
                    const suggestions = findEnvSuggestions(envVar.envHints || [envVar.name]);
                    formHTML += createParameterField(envVar, suggestions, 'envvar');
                });
            }
            
            parameterForm.innerHTML = formHTML;
            mcpSection.appendChild(parameterForm);
        }

        function createParameterField(param, suggestions, type) {
            const fieldId = `mcp_${type}_${param.name}`;
            const isRequired = param.required !== false;
            const suggestionsHTML = suggestions.length > 0 ? 
                `<div style="margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280;">
                    Suggestions: ${suggestions.map(s => `<span style="background: #374151; padding: 0.125rem 0.25rem; border-radius: 3px; margin-right: 0.25rem; cursor: pointer;" onclick="document.getElementById('${fieldId}').value='${s}'">${s}</span>`).join('')}
                </div>` : '';
            
            return `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.25rem;">
                        ${param.label} ${isRequired ? '<span style="color: #ef4444;">*</span>' : ''}
                    </label>
                    <input type="${type === 'envvar' ? 'password' : 'text'}" 
                           id="${fieldId}" 
                           name="${param.name}"
                           placeholder="${param.default || ''}"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #4b5563; border-radius: 4px; font-size: 0.875rem; background: #374151; color: #e5e7eb;"
                           ${isRequired ? 'required' : ''} />
                    <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #9ca3af;">
                        ${param.description}
                    </div>
                    ${suggestionsHTML}
                </div>
            `;
        }

        function findEnvSuggestions(hints) {
            if (!data.userEnvVars) return [];
            
            const suggestions = [];
            const userEnvKeys = Object.keys(data.userEnvVars).map(k => k.toLowerCase());
            
            hints.forEach(hint => {
                const hintLower = hint.toLowerCase();
                userEnvKeys.forEach(envKey => {
                    if (envKey.includes(hintLower) || hintLower.includes(envKey)) {
                        const originalKey = Object.keys(data.userEnvVars).find(k => k.toLowerCase() === envKey);
                        if (originalKey && !suggestions.includes(data.userEnvVars[originalKey])) {
                            suggestions.push(data.userEnvVars[originalKey]);
                        }
                    }
                });
            });
            
            return suggestions.slice(0, 3); // Limit to 3 suggestions
        }

        function updateProjectsList() {
            const projectSelect = document.getElementById('mcpProject');
            projectSelect.innerHTML = '<option value="">Select project...</option>';
            
            const managedProjectSelect = document.getElementById('managedMcpProject');
            if (managedProjectSelect) {
                managedProjectSelect.innerHTML = '<option value="">Select project...</option>';
            }
            
            if (data.projects) {
                Object.entries(data.projects).forEach(([name, project]) => {
                    const option = document.createElement('option');
                    option.value = project.path;
                    option.textContent = name;
                    projectSelect.appendChild(option);

                    // Also add to managed MCP project select
                    if (managedProjectSelect) {
                        const managedOption = document.createElement('option');
                        managedOption.value = name;
                        managedOption.textContent = name;
                        managedProjectSelect.appendChild(managedOption);
                    }
                });
            }
        }

        // Config Display and Editing Functions
        function createConfigDisplay(content, type, filePath, isEmpty = false) {
            const uniqueId = 'config_' + Math.random().toString(36).substr(2, 9);
            const isLarge = content.length > 500;
            
            let displayContent = '';
            if (type === 'json' && !isEmpty) {
                displayContent = `<div class="json-syntax">${highlightJson(content)}</div>`;
            } else if (type === 'markdown' && !isEmpty) {
                displayContent = `<div class="markdown-content">${renderMarkdown(content)}</div>`;
            } else {
                displayContent = `<div class="text-content">${escapeHtml(content)}</div>`;
            }

            const collapseButton = isLarge ? `<button class="collapse-toggle" onclick="toggleCollapse('${uniqueId}')">▼</button>` : '';
            const editButton = `<button class="edit-toggle" onclick="toggleEdit('${uniqueId}', '${type}', '${escapeHtml(filePath)}')">✏️</button>`;
            
            return `
                <div class="config-container" style="position: relative;">
                    ${collapseButton}
                    ${editButton}
                    <div id="${uniqueId}" class="config-content ${isLarge ? 'collapsible' : ''}" data-content="${escapeHtml(content)}" data-type="${type}" data-path="${escapeHtml(filePath)}">
                        ${displayContent}
                    </div>
                </div>
            `;
        }

        function createCommandsDisplay(commands, scope, isEmpty = false) {
            const uniqueId = 'commands_' + Math.random().toString(36).substr(2, 9);
            
            if (isEmpty || Object.keys(commands).length === 0) {
                const addButton = `<button class="edit-toggle" onclick="openCommandEditor('${scope}', '', '', '')">➕</button>`;
                return `
                    <div class="config-container" style="position: relative;">
                        ${addButton}
                        <div class="text-content">No commands found</div>
                    </div>
                `;
            }

            const commandsList = Object.entries(commands).map(([name, command]) => {
                if (command.error) {
                    return `<div class="command-item error">❌ ${name}: ${command.error}</div>`;
                }
                
                const preview = command.content ? command.content.substring(0, 100) + (command.content.length > 100 ? '...' : '') : '';
                return `
                    <div class="command-item">
                        <div class="command-header">
                            <span class="command-name">/${name}</span>
                            <button class="command-edit-btn" onclick="openCommandEditor('${scope}', '${escapeHtml(name)}', '${escapeHtml(command.content)}', '${escapeHtml(command.path)}')">✏️</button>
                            <button class="command-delete-btn" onclick="deleteCommand('${scope}', '${escapeHtml(name)}')">🗑️</button>
                        </div>
                        <div class="command-preview">${escapeHtml(preview)}</div>
                    </div>
                `;
            }).join('');

            const addButton = `<button class="edit-toggle" onclick="openCommandEditor('${scope}', '', '', '')">➕</button>`;
            
            return `
                <div class="config-container" style="position: relative;">
                    ${addButton}
                    <div id="${uniqueId}" class="commands-content">
                        ${commandsList}
                    </div>
                </div>
            `;
        }

        function createCommandsDisplayV2(commands, scope, isEmpty = false) {
            const uniqueId = 'commands_' + Math.random().toString(36).substr(2, 9);
            
            if (isEmpty || Object.keys(commands).length === 0) {
                const exampleCommands = getExampleCommands();
                return `
                    <div class="config-container" style="position: relative;">
                        <button class="edit-toggle" onclick="addNewCommand('${scope}')">➕</button>
                        <div class="text-content" style="padding: 1rem;">
                            <p style="margin-bottom: 1rem; color: #9ca3af;">No commands found. Commands are custom prompts you can invoke with <code>/${'{'}command-name}</code>.</p>
                            <details style="margin-top: 1rem;">
                                <summary style="cursor: pointer; color: #60a5fa; font-weight: 600;">Show Examples</summary>
                                <div style="margin-top: 1rem; background: #374151; border-radius: 4px; padding: 1rem;">
                                    ${exampleCommands}
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            }

            const commandsList = Object.entries(commands).map(([name, command]) => {
                if (command.error) {
                    return `<div class="command-item error">❌ ${name}: ${command.error}</div>`;
                }
                
                const commandId = `cmd_${uniqueId}_${name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                return `
                    <div class="command-item" id="${commandId}">
                        <div class="command-header">
                            <span class="command-name">/${name}</span>
                            <div class="command-actions">
                                <button class="command-edit-btn" onclick="editCommandInline('${commandId}', '${scope}', '${escapeHtml(name)}', '${escapeHtml(command.content)}')">✏️</button>
                                <button class="command-delete-btn" onclick="deleteCommandV2('${scope}', '${escapeHtml(name)}')">🗑️</button>
                            </div>
                        </div>
                        <div class="command-content" id="${commandId}_content">
                            ${formatCommandContent(command)}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="config-container" style="position: relative;">
                    <button class="edit-toggle" onclick="addNewCommand('${scope}')">➕</button>
                    <div id="${uniqueId}" class="commands-content">
                        ${commandsList}
                    </div>
                </div>
            `;
        }

        function formatCommandContent(command) {
            if (!command.content) {
                return '<div class="command-display">No content</div>';
            }
            
            const content = command.content;
            
            // Check if content has YAML frontmatter
            if (content.startsWith('---')) {
                const parts = content.split('---');
                if (parts.length >= 3) {
                    const frontmatter = parts[1].trim();
                    const body = parts.slice(2).join('---').trim();
                    
                    // Parse frontmatter
                    const yamlLines = frontmatter.split('\n').filter(line => line.trim());
                    let description = '';
                    let allowedTools = '';
                    
                    yamlLines.forEach(line => {
                        if (line.includes('description:')) {
                            description = line.split('description:')[1].trim();
                        }
                        if (line.includes('allowed-tools:')) {
                            allowedTools = line.split('allowed-tools:')[1].trim();
                        }
                    });
                    
                    return `
                        <div class="command-display">
                            ${description ? `<div class="command-description">${escapeHtml(description)}</div>` : ''}
                            ${allowedTools ? `<div class="command-tools"><strong>Tools:</strong> ${escapeHtml(allowedTools)}</div>` : ''}
                            ${body ? `<div class="command-body">${escapeHtml(body)}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            // Fallback to showing full content if no frontmatter
            return `<pre class="command-display">${escapeHtml(content)}</pre>`;
        }

        function getExampleCommands() {
            return `
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #60a5fa;">optimize.md</strong>
                    <pre style="background: #1f2937; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.875rem;">Analyze this code for performance issues and suggest optimizations.</pre>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #60a5fa;">security-review.md</strong>
                    <pre style="background: #1f2937; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.875rem;">Review this code for security vulnerabilities and provide recommendations.</pre>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #60a5fa;">git-commit.md</strong>
                    <pre style="background: #1f2937; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.875rem;">---
allowed-tools: Bash(git add:*), Bash(git status:*), Bash(git commit:*)
description: Create a git commit
---

## Context
- Current git status: !\`git status\`
- Current git diff: !\`git diff HEAD\`
- Current branch: !\`git branch --show-current\`

## Your task
Based on the above changes, create a single git commit.</pre>
                </div>
            `;
        }

        function highlightJson(jsonString) {
            return jsonString
                .replace(/("[\w\s_-]+")(\s*:\s*)/g, '<span class="json-key">$1</span>$2')
                .replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>')
                .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
        }

        function renderMarkdown(markdown) {
            return markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gis, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleCollapse(elementId) {
            const element = document.getElementById(elementId);
            const button = element.parentElement.querySelector('.collapse-toggle');
            
            if (element.classList.contains('collapsible')) {
                element.classList.remove('collapsible');
                element.classList.add('expanded');
                if (button) button.textContent = '▲';
            } else {
                element.classList.add('collapsible');
                element.classList.remove('expanded');
                if (button) button.textContent = '▼';
            }
        }

        function toggleEdit(elementId, type, filePath) {
            const element = document.getElementById(elementId);
            const content = element.dataset.content;
            
            if (element.classList.contains('editing')) {
                // Cancel editing
                element.classList.remove('editing');
                element.innerHTML = type === 'json' ? highlightJson(content) : 
                                 type === 'markdown' ? renderMarkdown(content) : escapeHtml(content);
            } else {
                // Start editing
                element.classList.add('editing');
                const editorClass = type === 'json' ? 'json-editor' : 'markdown-editor';
                element.innerHTML = `
                    <textarea class="${editorClass}" id="editor_${elementId}">${content}</textarea>
                    ${type === 'markdown' ? '<div class="markdown-preview" id="preview_' + elementId + '"></div>' : ''}
                    <div class="editor-controls">
                        <button class="btn-small" onclick="saveFile('${elementId}', '${type}', '${filePath}')">Save</button>
                        <button class="btn-small secondary" onclick="cancelEdit('${elementId}', '${type}')">Cancel</button>
                        ${type === 'markdown' ? '<button class="btn-small secondary" onclick="previewMarkdown(\'' + elementId + '\')">Preview</button>' : ''}
                    </div>
                `;
                
                if (type === 'markdown') {
                    document.getElementById(`editor_${elementId}`).addEventListener('input', function() {
                        previewMarkdown(elementId);
                    });
                    previewMarkdown(elementId);
                }
            }
        }

        function cancelEdit(elementId, type) {
            const element = document.getElementById(elementId);
            const content = element.dataset.content;
            
            element.classList.remove('editing');
            element.innerHTML = type === 'json' ? highlightJson(content) : 
                             type === 'markdown' ? renderMarkdown(content) : escapeHtml(content);
        }

        // Inline Command Management Functions
        function addNewCommand(scope) {
            openCommandEditorV2(scope, '', '');
        }

        function editCommandInline(commandId, scope, commandName, content) {
            const commandElement = document.getElementById(commandId);
            const contentElement = document.getElementById(`${commandId}_content`);
            
            if (contentElement.classList.contains('editing')) {
                return; // Already editing
            }
            
            contentElement.classList.add('editing');
            contentElement.innerHTML = `
                <textarea 
                    id="${commandId}_editor" 
                    style="width: 100%; min-height: 120px; background: #1f2937; border: 1px solid #4b5563; border-radius: 4px; color: #f9fafb; font-family: 'SF Mono', Monaco, monospace; font-size: 0.875rem; padding: 0.75rem; resize: vertical;"
                >${escapeHtml(content)}</textarea>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                    <button 
                        onclick="saveInlineCommand('${commandId}', '${scope}', '${escapeHtml(commandName)}')"
                        style="background: #059669; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                    >
                        Save
                    </button>
                    <button 
                        onclick="cancelInlineEdit('${commandId}', '${escapeHtml(content)}')"
                        style="background: #6b7280; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;"
                    >
                        Cancel
                    </button>
                </div>
            `;
        }

        async function saveInlineCommand(commandId, scope, commandName) {
            const editor = document.getElementById(`${commandId}_editor`);
            const content = editor.value;
            
            try {
                const projectName = scope === 'user' ? undefined : scope;
                
                const response = await fetch('/api/save-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scope: scope === 'user' ? 'user' : 'project', 
                        projectName, 
                        commandName, 
                        content 
                    })
                });
                
                if (response.ok) {
                    // Update display
                    const contentElement = document.getElementById(`${commandId}_content`);
                    contentElement.classList.remove('editing');
                    contentElement.innerHTML = `<pre class="command-display">${escapeHtml(content)}</pre>`;
                    
                    // Refresh data
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function cancelInlineEdit(commandId, originalContent) {
            const contentElement = document.getElementById(`${commandId}_content`);
            contentElement.classList.remove('editing');
            contentElement.innerHTML = `<pre class="command-display">${escapeHtml(originalContent)}</pre>`;
        }

        async function deleteCommandV2(scope, commandName) {
            if (!confirm(`Are you sure you want to delete the command "/${commandName}"?`)) {
                return;
            }
            
            try {
                const projectName = scope === 'user' ? undefined : scope;
                
                const response = await fetch('/api/delete-command', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scope: scope === 'user' ? 'user' : 'project', 
                        projectName, 
                        commandName 
                    })
                });
                
                if (response.ok) {
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function openCommandEditorV2(scope, commandName, content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            const isEditing = commandName !== '';
            const title = isEditing ? `Edit Command: /${commandName}` : 'Create New Command';
            
            modalContent.innerHTML = `
                <h3 style="color: #f9fafb; margin-bottom: 1rem; font-size: 1.25rem;">
                    ${title}
                </h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                        Command Name:
                    </label>
                    <input 
                        type="text" 
                        id="commandNameInput" 
                        value="${escapeHtml(commandName)}" 
                        placeholder="optimize" 
                        ${isEditing ? 'readonly' : ''}
                        style="width: 100%; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #f9fafb; font-family: monospace;"
                    />
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                        Command Content:
                    </label>
                    <textarea 
                        id="commandContentInput" 
                        placeholder="Analyze this code for performance issues and suggest optimizations."
                        style="width: 100%; height: 200px; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #f9fafb; font-family: monospace; resize: vertical;"
                    >${escapeHtml(content)}</textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button 
                        onclick="closeModal()" 
                        style="background: #6b7280; color: #f9fafb; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveCommandV2('${scope}', '${commandName}')" 
                        style="background: #3b82f6; color: #f9fafb; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;"
                    >
                        ${isEditing ? 'Update' : 'Create'} Command
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        async function saveCommandV2(scope, originalName) {
            const commandName = document.getElementById('commandNameInput').value.trim();
            const content = document.getElementById('commandContentInput').value;
            
            if (!commandName) {
                alert('Command name is required');
                return;
            }
            
            // Validate command name (no special characters except slash for namespacing)
            if (!/^[a-zA-Z0-9/_-]+$/.test(commandName)) {
                alert('Command name can only contain letters, numbers, hyphens, underscores, and forward slashes for namespacing');
                return;
            }
            
            try {
                const projectName = scope === 'user' ? undefined : scope;
                
                const response = await fetch('/api/save-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scope: scope === 'user' ? 'user' : 'project', 
                        projectName, 
                        commandName, 
                        content 
                    })
                });
                
                if (response.ok) {
                    alert('Command saved successfully!');
                    closeModal();
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Legacy Command Management Functions
        function openCommandEditor(scope, commandName, content, filePath) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            const isEditing = commandName !== '';
            const title = isEditing ? `Edit Command: /${commandName}` : 'Create New Command';
            
            modalContent.innerHTML = `
                <h3 style="color: #f9fafb; margin-bottom: 1rem; font-size: 1.25rem;">
                    ${title}
                </h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                        Command Name:
                    </label>
                    <input 
                        type="text" 
                        id="commandNameInput" 
                        value="${escapeHtml(commandName)}" 
                        placeholder="optimize" 
                        ${isEditing ? 'readonly' : ''}
                        style="width: 100%; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #f9fafb; font-family: monospace;"
                    />
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                        Command Content:
                    </label>
                    <textarea 
                        id="commandContentInput" 
                        placeholder="Analyze this code for performance issues"
                        style="width: 100%; height: 200px; padding: 0.5rem; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: #f9fafb; font-family: monospace; resize: vertical;"
                    >${escapeHtml(content)}</textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button 
                        onclick="closeModal()" 
                        style="background: #6b7280; color: #f9fafb; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="saveCommand('${scope}', '${commandName}')" 
                        style="background: #3b82f6; color: #f9fafb; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;"
                    >
                        ${isEditing ? 'Update' : 'Create'} Command
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        async function saveCommand(scope, originalName) {
            const commandName = document.getElementById('commandNameInput').value.trim();
            const content = document.getElementById('commandContentInput').value;
            
            if (!commandName) {
                alert('Command name is required');
                return;
            }
            
            // Validate command name (no special characters except slash for namespacing)
            if (!/^[a-zA-Z0-9/_-]+$/.test(commandName)) {
                alert('Command name can only contain letters, numbers, hyphens, underscores, and forward slashes for namespacing');
                return;
            }
            
            try {
                const projectName = scope === 'project' ? currentScope : undefined;
                
                const response = await fetch('/api/save-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scope, 
                        projectName, 
                        commandName, 
                        content 
                    })
                });
                
                if (response.ok) {
                    alert('Command saved successfully!');
                    closeModal();
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteCommand(scope, commandName) {
            if (!confirm(`Are you sure you want to delete the command "/${commandName}"?`)) {
                return;
            }
            
            try {
                const projectName = scope === 'project' ? currentScope : undefined;
                
                const response = await fetch('/api/delete-command', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scope, 
                        projectName, 
                        commandName 
                    })
                });
                
                if (response.ok) {
                    alert('Command deleted successfully!');
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function previewMarkdown(elementId) {
            const editor = document.getElementById(`editor_${elementId}`);
            const preview = document.getElementById(`preview_${elementId}`);
            
            if (editor && preview) {
                preview.innerHTML = renderMarkdown(editor.value);
            }
        }

        async function saveFile(elementId, type, filePath) {
            const editor = document.getElementById(`editor_${elementId}`);
            const content = editor.value;
            
            try {
                const response = await fetch('/api/save-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePath, content, type })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('File saved successfully!');
                    
                    // Update the element's data and display
                    const element = document.getElementById(elementId);
                    element.dataset.content = content;
                    cancelEdit(elementId, type);
                    
                    // Refresh data to show changes
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Hook Preset Functions
        function onHookEventChange() {
            const event = document.getElementById('hookEvent').value;
            const presetSelect = document.getElementById('hookPreset');
            
            // Clear existing options except "Custom Hook"
            presetSelect.innerHTML = '<option value="">Custom Hook</option>';
            
            if (commonHooks[event]) {
                commonHooks[event].forEach((hookPreset, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = hookPreset.name;
                    presetSelect.appendChild(option);
                });
            }
        }

        function onHookPresetChange() {
            const event = document.getElementById('hookEvent').value;
            const presetIndex = document.getElementById('hookPreset').value;
            const patternInput = document.getElementById('hookPattern');
            const commandInput = document.getElementById('hookCommand');
            
            if (presetIndex !== '' && commonHooks[event] && commonHooks[event][presetIndex]) {
                const preset = commonHooks[event][presetIndex];
                patternInput.value = preset.pattern;
                commandInput.value = preset.command;
            } else {
                // Clear for custom input
                patternInput.value = '*';
                commandInput.value = '';
            }
        }

        // API Functions
        async function addMcpServer() {
            const name = document.getElementById('mcpName').value;
            const command = document.getElementById('mcpCommand').value;
            const scope = document.getElementById('mcpScope').value;
            const template = document.getElementById('mcpTemplate').value;
            const projectPath = document.getElementById('mcpProject').value;
            
            if (!name || (!command && !template)) {
                alert('Please fill in server name and command/template');
                return;
            }

            // For Claude Code target, check scope requirements
            if (currentMcpTarget === 'claude-code' && scope === 'project' && !projectPath) {
                alert('Please select a project for project scope');
                return;
            }

            // Check if template has variables that need configuration
            if (template && mcpTemplates[template]) {
                const templateConfig = mcpTemplates[template];
                const hasParameters = templateConfig.parameters && templateConfig.parameters.length > 0;
                const hasEnvVars = templateConfig.envVars && templateConfig.envVars.length > 0;
                
                // If template has configurable variables, show modal
                if (hasParameters || hasEnvVars) {
                    showMcpVariableModal(template, templateConfig);
                    return;
                }
            }

            // No variables needed, proceed directly
            await performMcpServerAdd();
        }

        function showMcpVariableModal(template, templateConfig) {
            const modal = document.getElementById('mcpVariableModal');
            const title = document.getElementById('mcpModalTitle');
            const description = document.getElementById('mcpModalDescription');
            const fieldsContainer = document.getElementById('mcpModalFields');
            
            title.textContent = `Configure ${templateConfig.name}`;
            description.textContent = templateConfig.description || '';
            
            // Clear previous fields
            fieldsContainer.innerHTML = '';
            
            // Add parameter fields
            if (templateConfig.parameters) {
                templateConfig.parameters.forEach(param => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = `mcp-modal-field ${param.required ? 'required' : ''}`;
                    
                    fieldDiv.innerHTML = `
                        <label>${param.label}</label>
                        ${param.description ? `<div class="field-description">${param.description}</div>` : ''}
                        <div class="env-input-container">
                            <input type="text" id="modal_param_${param.name}" placeholder="${param.default || ''}" />
                            <button type="button" class="env-var-selector" onclick="toggleEnvVarDropdown('modal_param_${param.name}')">
                                📎
                            </button>
                            <div class="env-var-dropdown" id="dropdown_modal_param_${param.name}"></div>
                        </div>
                    `;
                    
                    fieldsContainer.appendChild(fieldDiv);
                });
            }
            
            // Add environment variable fields
            if (templateConfig.envVars) {
                templateConfig.envVars.forEach(envVar => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = `mcp-modal-field ${envVar.required ? 'required' : ''}`;
                    
                    const inputType = envVar.name.toLowerCase().includes('token') || envVar.name.toLowerCase().includes('key') ? 'password' : 'text';
                    
                    fieldDiv.innerHTML = `
                        <label>${envVar.label}</label>
                        ${envVar.description ? `<div class="field-description">${envVar.description}</div>` : ''}
                        <div class="env-input-container">
                            <input type="${inputType}" id="modal_env_${envVar.name}" placeholder="${envVar.default || ''}" />
                            <button type="button" class="env-var-selector" onclick="toggleEnvVarDropdown('modal_env_${envVar.name}')">
                                📎
                            </button>
                            <div class="env-var-dropdown" id="dropdown_modal_env_${envVar.name}"></div>
                        </div>
                    `;
                    
                    fieldsContainer.appendChild(fieldDiv);
                });
            }
            
            // Store template info for confirmation
            modal.dataset.template = template;
            
            // Show modal
            modal.classList.add('show');
        }

        function closeMcpModal() {
            const modal = document.getElementById('mcpVariableModal');
            modal.classList.remove('show');
        }

        async function confirmMcpVariables() {
            const modal = document.getElementById('mcpVariableModal');
            const template = modal.dataset.template;
            const isManaged = modal.dataset.isManaged === 'true';
            const templateConfig = mcpTemplates[template];
            
            // Collect values from modal inputs
            const parameters = {};
            const envVars = {};
            let missingRequired = [];
            
            // Determine ID prefix based on context
            const idPrefix = isManaged ? 'param_' : 'modal_param_';
            const envIdPrefix = isManaged ? 'env_' : 'modal_env_';
            
            // Collect parameters
            if (templateConfig.parameters) {
                templateConfig.parameters.forEach(param => {
                    const input = document.getElementById(`${idPrefix}${param.name}`);
                    if (input) {
                        const value = input.value.trim();
                        if (param.required && !value) {
                            missingRequired.push(param.label);
                        } else if (value) {
                            parameters[param.name] = value;
                        }
                    }
                });
            }
            
            // Collect environment variables
            if (templateConfig.envVars) {
                templateConfig.envVars.forEach(envVar => {
                    const input = document.getElementById(`${envIdPrefix}${envVar.name}`);
                    if (input) {
                        const value = input.value.trim();
                        if (envVar.required && !value) {
                            missingRequired.push(envVar.label);
                        } else if (value) {
                            envVars[envVar.name] = value;
                        }
                    }
                });
            }
            
            if (missingRequired.length > 0) {
                alert(`Please fill in required fields: ${missingRequired.join(', ')}`);
                return;
            }
            
            // Close modal and proceed with server addition
            closeMcpModal();
            
            if (isManaged) {
                await performManagedMcpServerAdd(parameters, envVars);
            } else {
                await performMcpServerAdd(parameters, envVars);
            }
        }

        async function performMcpServerAdd(modalParameters = {}, modalEnvVars = {}) {
            const name = document.getElementById('mcpName').value;
            const command = document.getElementById('mcpCommand').value;
            const scope = document.getElementById('mcpScope').value;
            const template = document.getElementById('mcpTemplate').value;
            const projectPath = document.getElementById('mcpProject').value;

            // Collect parameters and environment variables from existing form (for backward compatibility)
            const parameters = { ...modalParameters };
            const envVars = { ...modalEnvVars };
            let missingRequired = [];

            if (template && mcpTemplates[template]) {
                const templateConfig = mcpTemplates[template];
                
                // Only collect from form if not already provided by modal
                if (Object.keys(modalParameters).length === 0) {
                    // Collect command parameters
                    if (templateConfig.parameters) {
                        templateConfig.parameters.forEach(param => {
                            const input = document.getElementById(`mcp_parameter_${param.name}`);
                            if (input) {
                                const value = input.value.trim();
                                if (param.required && !value) {
                                    missingRequired.push(param.label);
                                } else if (value) {
                                    parameters[param.name] = value;
                                }
                            }
                        });
                    }
                    
                    // Collect environment variables
                    if (templateConfig.envVars) {
                        templateConfig.envVars.forEach(envVar => {
                            const input = document.getElementById(`mcp_envvar_${envVar.name}`);
                            if (input) {
                                const value = input.value.trim();
                                if (envVar.required && !value) {
                                    missingRequired.push(envVar.label);
                                } else if (value) {
                                    envVars[envVar.name] = value;
                                }
                            }
                        });
                    }
                }
            }

            if (missingRequired.length > 0) {
                alert(`Please fill in required fields: ${missingRequired.join(', ')}`);
                return;
            }

            try {
                const response = await fetch('/api/add-mcp-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, 
                        command, 
                        scope, 
                        template, 
                        projectPath, 
                        parameters, 
                        envVars,
                        target: currentMcpTarget
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'MCP server added successfully');
                    document.getElementById('mcpName').value = '';
                    document.getElementById('mcpCommand').value = '';
                    document.getElementById('mcpTemplate').value = '';
                    clearMcpParameterForm();
                    onTemplateChange(); // Reset form
                    
                    // Refresh appropriate server list
                    if (currentMcpTarget === 'claude-desktop') {
                        updateClaudeDesktopMcpServers();
                    } else {
                        refreshData();
                    }
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function addHook() {
            const event = document.getElementById('hookEvent').value;
            const pattern = document.getElementById('hookPattern').value || '*';
            const command = document.getElementById('hookCommand').value;
            
            if (!command) {
                alert('Please enter a command');
                return;
            }

            try {
                const response = await fetch('/api/add-hook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event, pattern, command })
                });
                
                if (response.ok) {
                    document.getElementById('hookPattern').value = '';
                    document.getElementById('hookCommand').value = '';
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function unregisterProject(projectName) {
            if (!confirm(`Are you sure you want to unregister project "${projectName}"?\n\nThis will:\n- Remove it from the Claude Manager registry\n- Clean up associated environment variables\n- Stop monitoring its configuration files\n\nThe project files themselves will NOT be deleted.`)) {
                return;
            }

            try {
                const response = await fetch('/api/unregister-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: projectName })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Project unregistered successfully');
                    
                    // If we're currently viewing this project, switch back to user scope
                    if (currentScope === projectName) {
                        currentScope = 'user';
                        document.getElementById('scopeSelect').value = 'user';
                    }
                    
                    refreshData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }


        // Session Tracking Functions
        let sessionCountdownInterval = null;

        async function toggleSessionTracking(enabled) {
            try {
                const response = await fetch('/api/toggle-session-tracking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to toggle session tracking');
                }
            } catch (error) {
                console.error('Error toggling session tracking:', error);
                document.getElementById('sessionTrackingToggle').checked = !enabled;
                alert(`Error: ${error.message}`);
            }
        }

        function toggleSessionDetailsPanel() {
            const panel = document.getElementById('sessionDetailsPanel');
            const overlay = document.getElementById('panelOverlay');
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                overlay.classList.remove('show');
                setTimeout(() => overlay.style.display = 'none', 300);
            } else {
                overlay.style.display = 'block';
                setTimeout(() => {
                    overlay.classList.add('show');
                    panel.classList.add('open');
                }, 10);
                updateSessionDetails();
            }
        }

        function closeSessionDetailsPanel() {
            const panel = document.getElementById('sessionDetailsPanel');
            const overlay = document.getElementById('panelOverlay');
            panel.classList.remove('open');
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 300);
        }

        async function updateSessionDetails() {
            try {
                const response = await fetch('/api/session-status');
                const data = await response.json();
                
                document.getElementById('monthlySessionCount').textContent = data.monthlySessions || 0;
                document.getElementById('billingDateSelect').value = data.billingDate || 1;
                
                // Calculate monthly projection based on current usage
                const currentDate = new Date();
                const billingDate = data.billingDate || 1;
                const monthlySessions = data.monthlySessions || 0;
                
                // Calculate days elapsed in current billing period
                let periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), billingDate);
                if (currentDate.getDate() < billingDate) {
                    periodStart.setMonth(periodStart.getMonth() - 1);
                }
                
                const daysElapsed = Math.max(1, Math.ceil((currentDate - periodStart) / (1000 * 60 * 60 * 24)));
                const daysInMonth = 30; // Approximate for simplicity
                
                // Monthly projection
                const monthlyProjection = Math.round((monthlySessions / daysElapsed) * daysInMonth);
                document.getElementById('monthlyProjection').textContent = `${monthlyProjection} per month`;
                
                // Calculate daily target to reach 50 sessions per month
                const daysRemaining = Math.max(1, daysInMonth - daysElapsed);
                const sessionsNeeded = Math.max(0, 50 - monthlySessions);
                const dailyTarget = Math.ceil(sessionsNeeded / daysRemaining);
                
                document.getElementById('dailyTarget').textContent = `${dailyTarget} per day for ${daysRemaining} days`;
            } catch (error) {
                console.error('Error updating session details:', error);
            }
        }

        async function changeBillingDate(date) {
            try {
                const response = await fetch('/api/set-billing-date', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ billingDate: parseInt(date) })
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to update billing date');
                }
                updateSessionDetails();
            } catch (error) {
                console.error('Error changing billing date:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function updateSessionCountdown(stats) {
            const countdownDiv = document.getElementById('sessionCountdown');
            const timerSpan = document.getElementById('countdownTimer');
            
            if (stats.enabled && stats.isActive && stats.timeRemaining) {
                countdownDiv.style.display = 'block';
                const hours = Math.floor(stats.timeRemaining / (1000 * 60 * 60));
                const minutes = Math.floor((stats.timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((stats.timeRemaining % (1000 * 60)) / 1000);
                timerSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                countdownDiv.style.display = 'none';
            }
            
            // Update toggle state
            document.getElementById('sessionTrackingToggle').checked = stats.enabled;
            
            // Update session details in the panel
            updateCurrentSessionMetrics(stats);
        }
        
        // Original function for monthly session data and projections
        async function updateSessionDetails() {
            try {
                const response = await fetch('/api/session-status');
                const data = await response.json();
                
                document.getElementById('monthlySessionCount').textContent = data.monthlySessions || 0;
                document.getElementById('billingDateSelect').value = data.billingDate || 1;
                
                // Calculate monthly projection based on current usage
                const currentDate = new Date();
                const billingDate = data.billingDate || 1;
                const monthlySessions = data.monthlySessions || 0;
                
                // Calculate days elapsed in current billing period
                let periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), billingDate);
                if (currentDate.getDate() < billingDate) {
                    periodStart.setMonth(periodStart.getMonth() - 1);
                }
                
                const daysElapsed = Math.max(1, Math.ceil((currentDate - periodStart) / (1000 * 60 * 60 * 24)));
                const daysInMonth = 30; // Approximate for simplicity
                
                // Monthly projection
                const monthlyProjection = Math.round((monthlySessions / daysElapsed) * daysInMonth);
                document.getElementById('monthlyProjection').textContent = `${monthlyProjection} per month`;
                
                // Calculate daily target to reach 50 sessions per month
                const daysRemaining = Math.max(1, daysInMonth - daysElapsed);
                const sessionsNeeded = Math.max(0, 50 - monthlySessions);
                const dailyTarget = Math.ceil(sessionsNeeded / daysRemaining);
                
                document.getElementById('dailyTarget').textContent = `${dailyTarget} per day for ${daysRemaining} days`;
                
            } catch (error) {
                console.error('Error updating session details:', error);
                document.getElementById('monthlySessionCount').textContent = 'Error';
                document.getElementById('monthlyProjection').textContent = 'Error loading data';
                document.getElementById('dailyTarget').textContent = 'Error loading data';
            }
        }

        // New function for current/previous session metrics with costs
        function updateCurrentSessionMetrics(stats) {
            // Helper function to format cost
            const formatCost = (cost) => {
                if (cost < 0.01) {
                    return '< $0.01';
                }
                return `$${cost.toFixed(2)}`;
            };
            
            // Update current session details
            const currentSessionSection = document.getElementById('currentSessionSection');
            if (stats.currentSession) {
                currentSessionSection.style.display = 'block';
                document.getElementById('currentSessionPrompts').textContent = stats.currentSession.userPrompts || 0;
                document.getElementById('currentSessionResponses').textContent = stats.currentSession.assistantResponses || 0;
                document.getElementById('currentSessionTokens').textContent = (stats.currentSession.totalTokensUsed || 0).toLocaleString();
                document.getElementById('currentSessionInputTokens').textContent = (stats.currentSession.inputTokens || 0).toLocaleString();
                document.getElementById('currentSessionOutputTokens').textContent = (stats.currentSession.outputTokens || 0).toLocaleString();
                
                // Update cost estimates
                if (stats.currentSession.costs) {
                    document.getElementById('currentSessionSonnet4Cost').textContent = formatCost(stats.currentSession.costs.sonnet4);
                    document.getElementById('currentSessionOpus4Cost').textContent = formatCost(stats.currentSession.costs.opus4);
                }
            } else {
                currentSessionSection.style.display = 'none';
            }
            
            // Update previous session details
            const previousSessionSection = document.getElementById('previousSessionSection');
            if (stats.previousSession) {
                previousSessionSection.style.display = 'block';
                document.getElementById('previousSessionPrompts').textContent = stats.previousSession.userPrompts || 0;
                document.getElementById('previousSessionResponses').textContent = stats.previousSession.assistantResponses || 0;
                document.getElementById('previousSessionTokens').textContent = (stats.previousSession.totalTokensUsed || 0).toLocaleString();
                document.getElementById('previousSessionInputTokens').textContent = (stats.previousSession.inputTokens || 0).toLocaleString();
                document.getElementById('previousSessionOutputTokens').textContent = (stats.previousSession.outputTokens || 0).toLocaleString();
                
                // Format duration
                const duration = stats.previousSession.duration || 0;
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('previousSessionDuration').textContent = `${hours}h ${minutes}m`;
                
                // Update cost estimates
                if (stats.previousSession.costs) {
                    document.getElementById('previousSessionSonnet4Cost').textContent = formatCost(stats.previousSession.costs.sonnet4);
                    document.getElementById('previousSessionOpus4Cost').textContent = formatCost(stats.previousSession.costs.opus4);
                }
            } else {
                previousSessionSection.style.display = 'none';
            }
        }

        function toggleSettingsPanel() {
            // Placeholder for settings panel functionality
            alert('Settings panel not yet implemented');
        }


        // Environment variable selector functions
        function toggleEnvVarDropdown(inputId) {
            const dropdown = document.getElementById('dropdown_' + inputId);
            const allDropdowns = document.querySelectorAll('.env-var-dropdown');
            
            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                }
            });
            
            // Toggle this dropdown
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                populateEnvVarDropdown(dropdown, inputId);
                dropdown.classList.add('show');
            }
        }

        function populateEnvVarDropdown(dropdown, inputId) {
            // Get environment variables based on current scope
            let envVars = {};
            let scopeLabel = '';
            
            if (currentScope === 'user') {
                envVars = window.currentState?.userEnvVars || {};
                scopeLabel = 'user-level';
            } else {
                // Project scope - get project-specific env vars
                envVars = window.currentState?.projectEnvVars?.[currentScope] || {};
                scopeLabel = `project ${currentScope}`;
            }
            
            if (Object.keys(envVars).length === 0) {
                dropdown.innerHTML = `<div class="env-var-item" style="color: #9ca3af; font-style: italic;">No ${scopeLabel} environment variables configured</div>`;
                return;
            }
            
            let html = '';
            Object.entries(envVars).forEach(([key, value]) => {
                const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
                html += `
                    <div class="env-var-item" onclick="selectEnvVar('${inputId}', '${key}', \`${value.replace(/`/g, '\\`')}\`)">
                        <div class="env-var-key">${key}</div>
                        <div class="env-var-value">${displayValue}</div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
        }

        function selectEnvVar(inputId, key, value) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value;
                // Trigger input event to ensure any validation or change handlers are called
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            // Close the dropdown
            const dropdown = document.getElementById('dropdown_' + inputId);
            dropdown.classList.remove('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.env-input-container')) {
                document.querySelectorAll('.env-var-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Store current state globally for access by env var functions
        window.currentState = {};

        // TTS Notification System
        async function playTTSNotification(text) {
            try {
                console.log('Playing TTS notification:', text);
                
                const response = await fetch('/api/tts-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    throw new Error(`TTS API error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.audio) {
                    // Convert base64 to audio blob
                    const audioData = atob(result.audio);
                    const audioArray = new Uint8Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        audioArray[i] = audioData.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([audioArray], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Play the audio
                    const audio = new Audio(audioUrl);
                    audio.play().catch(err => {
                        console.error('Audio playback failed:', err);
                    });
                    
                    // Clean up URL after playing
                    audio.addEventListener('ended', () => {
                        URL.revokeObjectURL(audioUrl);
                    });
                } else {
                    throw new Error('Invalid TTS response');
                }
            } catch (error) {
                console.error('TTS notification failed:', error);
                // Fallback to browser notification or console log
                console.log('TTS FALLBACK:', text);
            }
        }

        // TTS notification hook - called by Claude Code when approval is needed
        window.claudeTTSNotification = function(message) {
            console.log('Claude Code TTS Notification:', message);
            playTTSNotification(message);
        };

        // Clipboard copy functionality
        async function copyToClipboard(text, keyName) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Visual feedback
                const copyButtons = document.querySelectorAll(`button[onclick*="${keyName}"]`);
                copyButtons.forEach(button => {
                    if (button.textContent.includes('📋')) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '✅';
                        button.style.color = '#10b981';
                        
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.color = '';
                        }, 1500);
                    }
                });
                
                console.log(`Copied "${keyName}" to clipboard`);
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);
                
                // Fallback for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    console.log(`Copied "${keyName}" to clipboard (fallback)`);
                } catch (fallbackErr) {
                    console.error('Clipboard copy failed completely:', fallbackErr);
                    alert(`Failed to copy to clipboard. Value: ${text}`);
                }
            }
        }

        // Initialize
        connect();
        loadTemplates();
        loadCommonHooks();
        loadManagedMcpServers();
        refreshData();
        
        // Check initial session tracking state
        fetch('/api/session-stats')
            .then(res => res.json())
            .then(stats => updateSessionCountdown(stats))
            .catch(console.error);
    </script>

    <!-- Session Details Panel -->
    <div id="panelOverlay" class="panel-overlay" onclick="closeSessionDetailsPanel()"></div>
    <div id="sessionDetailsPanel" class="slide-panel">
        <div class="slide-panel-header">
            <h2>Session Tracking Details</h2>
            <button class="slide-panel-close" onclick="closeSessionDetailsPanel()">✕</button>
        </div>
        <div class="slide-panel-content">
            <div class="session-info-section">
                <h3>Current Month</h3>
                <div class="session-stat">
                    <span class="session-stat-label">Sessions Used</span>
                    <span class="session-stat-value" id="monthlySessionCount">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Billing Date</span>
                    <div class="billing-date-picker">
                        <select id="billingDateSelect" onchange="changeBillingDate(this.value)">
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                            <option value="9">9th</option>
                            <option value="10">10th</option>
                            <option value="11">11th</option>
                            <option value="12">12th</option>
                            <option value="13">13th</option>
                            <option value="14">14th</option>
                            <option value="15">15th</option>
                            <option value="16">16th</option>
                            <option value="17">17th</option>
                            <option value="18">18th</option>
                            <option value="19">19th</option>
                            <option value="20">20th</option>
                            <option value="21">21st</option>
                            <option value="22">22nd</option>
                            <option value="23">23rd</option>
                            <option value="24">24th</option>
                            <option value="25">25th</option>
                            <option value="26">26th</option>
                            <option value="27">27th</option>
                            <option value="28">28th</option>
                        </select>
                        <span style="color: #9ca3af; font-size: 0.75rem;">of each month</span>
                    </div>
                </div>
            </div>
            
            <div class="session-info-section" id="currentSessionSection" style="display: none;">
                <h3>Current Session</h3>
                <div class="session-stat">
                    <span class="session-stat-label">User Prompts</span>
                    <span class="session-stat-value" id="currentSessionPrompts">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Assistant Responses</span>
                    <span class="session-stat-value" id="currentSessionResponses">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Total Tokens</span>
                    <span class="session-stat-value" id="currentSessionTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Input Tokens</span>
                    <span class="session-stat-value" id="currentSessionInputTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Output Tokens</span>
                    <span class="session-stat-value" id="currentSessionOutputTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">With Sonnet 4 would be</span>
                    <span class="session-stat-value" id="currentSessionSonnet4Cost">$0.00</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">With Opus 4 would be</span>
                    <span class="session-stat-value" id="currentSessionOpus4Cost">$0.00</span>
                </div>
            </div>
            
            <div class="session-info-section" id="previousSessionSection" style="display: none;">
                <h3>Previous Session</h3>
                <div class="session-stat">
                    <span class="session-stat-label">User Prompts</span>
                    <span class="session-stat-value" id="previousSessionPrompts">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Assistant Responses</span>
                    <span class="session-stat-value" id="previousSessionResponses">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Total Tokens</span>
                    <span class="session-stat-value" id="previousSessionTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Input Tokens</span>
                    <span class="session-stat-value" id="previousSessionInputTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Output Tokens</span>
                    <span class="session-stat-value" id="previousSessionOutputTokens">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">Duration</span>
                    <span class="session-stat-value" id="previousSessionDuration">0</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">With Sonnet 4 would be</span>
                    <span class="session-stat-value" id="previousSessionSonnet4Cost">$0.00</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">With Opus 4 would be</span>
                    <span class="session-stat-value" id="previousSessionOpus4Cost">$0.00</span>
                </div>
            </div>
            
            <div class="session-info-section">
                <h3>Usage Projections</h3>
                <div class="session-stat">
                    <span class="session-stat-label">Averaging to</span>
                    <span class="session-stat-value" id="monthlyProjection">0 per month</span>
                </div>
                <div class="session-stat">
                    <span class="session-stat-label">To reach 50/month</span>
                    <span class="session-stat-value" id="dailyTarget">0 per day for 0 days</span>
                </div>
            </div>
            
            <div class="session-info-section">
                <h3>About Sessions</h3>
                <p style="color: #9ca3af; font-size: 0.875rem; line-height: 1.5;">
                    A session is a 5-hour window that starts when you send your first message to Claude. 
                    All activity across any Claude Code project during this 5-hour period counts as a single session.
                </p>
            </div>
        </div>
    </div>
</body>
</html>
